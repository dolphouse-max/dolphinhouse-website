---
import Layout from "../layouts/Layout.astro";
---
<Layout title="Pay | Dolphin House">

  <section class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg mt-10 mb-20">
    <h1 class="text-2xl font-bold mb-4">Payment</h1>
    <div id="info" class="mb-4 text-gray-700"></div>

    <div class="mb-6 text-center">
      <img id="gpay" src="/uploader/gpay-qr.png" alt="GPay QR" class="mx-auto w-48 h-48 object-contain"/>
      <p class="text-sm text-gray-500 mt-2">Scan QR, pay the amount shown and upload payment screenshot below.</p>
    </div>

    <label class="block mb-2">Upload payment screenshot</label>
    <input id="screenshot" type="file" accept="image/*" class="mb-4" />
    <div id="preview" class="mb-4"></div>

    <div class="flex gap-4">
      <button id="confirmBtn" class="btn-primary">Confirm Payment</button>
      <a href="/booking" class="btn-secondary">Cancel</a>
    </div>

    <p id="msg" class="text-green-600 mt-4 hidden">Payment uploaded. Booking will be reviewed by admin.</p>
  </section>

  <script>
  const params = new URLSearchParams(location.search);
  const bookingId = params.get('bookingId');
  const infoDiv = document.getElementById('info');
  const msg = document.getElementById('msg');
  const preview = document.getElementById('preview');
  const fileInput = document.getElementById('screenshot');
  const confirmBtn = document.getElementById('confirmBtn');
  let screenshotData = null;
  let booking = null;

  // Fetch the booking from Cloudflare D1 API
  async function loadBooking() {
    try {
      const res = await fetch('/api/bookings');
      const data = await res.json();
      booking = data.find(b => b.id === bookingId);
      if (!booking) {
        infoDiv.textContent = 'Booking not found or already processed.';
        confirmBtn.disabled = true;
        return;
      }
      infoDiv.innerHTML = `
        <div><strong>Booking:</strong> ${booking.room} — ${booking.checkin} → ${booking.checkout}</div>
        <div><strong>Amount:</strong> ₹${booking.total}</div>
      `;
    } catch (err) {
      infoDiv.textContent = 'Error loading booking details.';
      console.error(err);
    }
  }

  // Handle image upload preview
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    preview.innerHTML = `<img src="${url}" class="w-48 h-48 object-contain rounded-lg shadow"/>`;
    const reader = new FileReader();
    reader.onload = () => screenshotData = reader.result;
    reader.readAsDataURL(f);
  });

  // Confirm payment and update booking in D1
  confirmBtn.addEventListener('click', async () => {
    if (!screenshotData) {
      alert('Please upload payment screenshot first.');
      return;
    }
    if (!booking) {
      alert('Booking not found.');
      return;
    }

    try {
      const updated = { ...booking, screenshot: screenshotData, status: 'payment_submitted' };
      const res = await fetch('/api/bookings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });
      if (res.ok) {
        msg.textContent = 'Payment uploaded. Booking will be reviewed by admin.';
        msg.classList.remove('hidden');
        confirmBtn.disabled = true;
        setTimeout(() => (window.location.href = '/thank-you'), 2000);
      } else {
        alert('Failed to update booking. Please try again.');
      }
    } catch (err) {
      console.error(err);
      alert('Error updating booking.');
    }
  });

  loadBooking();
</script>


</Layout>
