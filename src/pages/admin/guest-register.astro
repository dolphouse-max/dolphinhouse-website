---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminHeader from '../../components/AdminHeader.astro';
import { isAuthenticated } from '../../middleware/auth.js';

const ok = await isAuthenticated(Astro);
if (!ok) {
  return Astro.redirect('/admin/login');
}

const db = Astro.locals.runtime.env.DB;
const url = new URL(Astro.request.url);

// Filters via query params
const q = url.searchParams.get('q') || '';
const status = url.searchParams.get('status') || '';
const room = url.searchParams.get('room') || '';
const start = url.searchParams.get('start') || '';
const end = url.searchParams.get('end') || '';
const page = Math.max(1, parseInt(url.searchParams.get('page') || '1'));
const pageSize = Math.min(100, Math.max(10, parseInt(url.searchParams.get('pageSize') || '20')));
const offset = (page - 1) * pageSize;

function buildWhere(){
  const clauses = [];
  const values = [];
  if (q) {
    clauses.push('(name LIKE ? OR email LIKE ? OR mobile LIKE ? OR customer_id LIKE ?)');
    const like = `%${q}%`;
    values.push(like, like, like, like);
  }
  if (status) {
    clauses.push('LOWER(status) = LOWER(?)');
    values.push(status);
  }
  if (room) {
    clauses.push('room = ?');
    values.push(room);
  }
  if (start && end) {
    clauses.push('NOT (date(checkout) <= date(?) OR date(checkin) >= date(?))');
    values.push(start, end);
  } else if (start) {
    clauses.push('date(checkout) > date(?)');
    values.push(start);
  } else if (end) {
    clauses.push('date(checkin) < date(?)');
    values.push(end);
  }
  const where = clauses.length ? `WHERE ${clauses.join(' AND ')}` : '';
  return { where, values };
}

let rows = [];
let total = 0;
let rooms = [];
try {
  if (!db) throw new Error('DB binding unavailable');
  const { where, values } = buildWhere();
  const countSql = `SELECT COUNT(*) AS total FROM bookings ${where}`;
  const count = await db.prepare(countSql).bind(...values).first();
  total = (count && (count.total || count['COUNT(*)'])) || 0;

  const selectSql = `SELECT id, customer_id, name, email, mobile, room, checkin, checkout, nights, guests, total, status, createdAt
                     FROM bookings ${where}
                     ORDER BY date(checkin) DESC
                     LIMIT ? OFFSET ?`;
  const res = await db.prepare(selectSql).bind(...values, pageSize, offset).all();
  rows = res.results || [];

  const rres = await db.prepare('SELECT DISTINCT room FROM bookings ORDER BY room').all();
  rooms = (rres.results || []).map((r)=> r.room).filter(Boolean);
} catch (e) {
  console.error('[admin/guest-register] query error', e);
}
---
<AdminLayout title="Guest Register">
  <AdminHeader />

  <section class="max-w-7xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-semibold mb-4">Guest Register</h1>
    <p class="text-sm text-gray-600 mb-6">List of guests from bookings with filters, pagination, print and CSV export.</p>

    <form method="GET" class="grid grid-cols-1 md:grid-cols-6 gap-3 bg-white p-4 rounded-lg shadow border mb-4">
      <div>
        <label class="block text-xs text-gray-600 mb-1">Search</label>
        <input type="text" name="q" value={q} placeholder="Name, email, mobile, ID" class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Status</label>
        <select name="status" class="w-full border rounded px-3 py-2">
          <option value="">All</option>
          <option value="pending" selected={status==='pending'}>Pending</option>
          <option value="payment_pending" selected={status==='payment_pending'}>Payment Pending</option>
          <option value="confirmed" selected={status==='confirmed'}>Confirmed</option>
          <option value="cancelled" selected={status==='cancelled'}>Cancelled</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Room</label>
        <select name="room" class="w-full border rounded px-3 py-2">
          <option value="">All</option>
          {rooms.map(r => <option value={r} selected={room===r}>{r}</option>)}
        </select>
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">From</label>
        <input type="date" name="start" value={start} class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">To</label>
        <input type="date" name="end" value={end} class="w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Page Size</label>
        <input type="number" name="pageSize" min="10" max="100" value={pageSize} class="w-full border rounded px-3 py-2" />
      </div>
      <div class="md:col-span-6 flex gap-2 items-end">
        <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded hover:bg-sky-700">Apply</button>
        <a href="/admin/guest-register" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Reset</a>
        <button type="button" id="downloadCsv" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Download CSV</button>
        <button type="button" id="printBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Print</button>
      </div>
    </form>

    <div class="mb-3 text-sm text-gray-700">
      Total: {total} | Page {page} of {Math.max(1, Math.ceil(total / pageSize))}
    </div>

    <div class="overflow-x-auto bg-white rounded-lg shadow border">
      <table class="w-full text-sm border-collapse print:w-full">
        <thead class="bg-gray-100 border-b text-left text-gray-700 print:bg-white">
          <tr>
            <th class="px-4 py-2">Booking ID</th>
            <th class="px-4 py-2">Customer ID</th>
            <th class="px-4 py-2">Guest</th>
            <th class="px-4 py-2">Mobile</th>
            <th class="px-4 py-2">Email</th>
            <th class="px-4 py-2">Room</th>
            <th class="px-4 py-2">Check-in</th>
            <th class="px-4 py-2">Check-out</th>
            <th class="px-4 py-2">Nights</th>
            <th class="px-4 py-2">Guests</th>
            <th class="px-4 py-2">Total</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Created</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r) => (
            <tr>
              <td class="px-4 py-2">{String(r.id).slice(0,13)}…</td>
              <td class="px-4 py-2">{r.customer_id || ''}</td>
              <td class="px-4 py-2">{r.name || ''}</td>
              <td class="px-4 py-2">{r.mobile || ''}</td>
              <td class="px-4 py-2">{r.email || ''}</td>
              <td class="px-4 py-2">{r.room || ''}</td>
              <td class="px-4 py-2">{r.checkin || ''}</td>
              <td class="px-4 py-2">{r.checkout || ''}</td>
              <td class="px-4 py-2">{r.nights || ''}</td>
              <td class="px-4 py-2">{r.guests || ''}</td>
              <td class="px-4 py-2">{r.total || ''}</td>
              <td class="px-4 py-2">{r.status || ''}</td>
              <td class="px-4 py-2">{r.createdAt || ''}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div class="flex items-center gap-2 mt-4 print:hidden">
      {page > 1 && (
        <a href={`?${new URLSearchParams({ q, status, room, start, end, page: String(page-1), pageSize: String(pageSize) }).toString()}`} class="px-3 py-2 border rounded">← Prev</a>
      )}
      {page * pageSize < total && (
        <a href={`?${new URLSearchParams({ q, status, room, start, end, page: String(page+1), pageSize: String(pageSize) }).toString()}`} class="px-3 py-2 border rounded">Next →</a>
      )}
    </div>
  </section>

  <style>
    @media print {
      header, form, .print\:hidden, #downloadCsv, #printBtn { display: none !important; }
      table { font-size: 12px; }
      th, td { border: 1px solid #999; }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const downloadBtn = document.getElementById('downloadCsv');
      const printBtn = document.getElementById('printBtn');
      downloadBtn?.addEventListener('click', () => {
        const params = new URLSearchParams({ q: `${q}`, status: `${status}`, room: `${room}`, start: `${start}`, end: `${end}` });
        const url = `/api/guest-register.csv?${params.toString()}`;
        window.location.href = url;
      });
      printBtn?.addEventListener('click', () => window.print());
    });
  </script>
</AdminLayout>