---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminHeader from '../../components/AdminHeader.astro';
import { isAuthenticated } from '../../middleware/auth.js';

// Check if user is authenticated
const authenticated = await isAuthenticated(Astro);
if (!authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Admin Dashboard | Dolphin House">
  <AdminHeader />

  <!-- üîê Change Password Banner (dismissible) -->
  <section id="changePasswordBanner" class="max-w-6xl mx-auto mt-4 px-4">
    <div id="cpBanner" class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded-lg flex items-center justify-between">
      <span class="text-sm">For security, please update your admin password.</span>
      <div class="flex gap-2">
        <a href="/admin/change-password" class="px-3 py-1 bg-sky-600 text-white rounded hover:bg-sky-700 text-sm">Change Password</a>
        <button id="dismissCpBanner" class="px-3 py-1 border rounded text-sm">Dismiss</button>
      </div>
    </div>
  </section>

  <section id="reportArea" class="max-w-6xl mx-auto p-8 bg-white rounded-2xl shadow-lg mt-10 mb-16">
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center gap-4">
        <img src="/uploader/logo-512.webp" alt="Logo" class="w-12 h-12 rounded-full border shadow">
        <div>
          <h1 class="text-3xl font-bold text-sky-700">üè® Dolphin House Admin Dashboard</h1>
          <p class="text-gray-600">Bookings, Occupancy, and Revenue Insights</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="downloadPdfBtn" class="bg-rose-600 hover:bg-rose-700 text-white px-5 py-2 rounded-lg shadow">
          üì• Download PDF Report
        </button>
        <a href="/admin/change-password" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg shadow">
          üîê Change Password
        </a>
      </div>
    </div>

    <!-- üóì Filters -->
    <div class="flex flex-wrap justify-center items-center gap-4 mb-8">
      <div class="flex gap-2">
        <button class="filter-btn bg-sky-600 text-white px-4 py-2 rounded" data-filter="today">Today</button>
        <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" data-filter="week">This Week</button>
        <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" data-filter="month">This Month</button>
      </div>
      <div class="flex items-center gap-2">
        <input id="startDate" type="date" class="border rounded px-3 py-2" />
        <span>‚Üí</span>
        <input id="endDate" type="date" class="border rounded px-3 py-2" />
        <button id="applyRangeBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Apply</button>
      </div>
    </div>

    <!-- ‚úÖ Summary Cards -->
    <div id="summary" class="grid sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-10">
      <div class="p-6 bg-sky-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Bookings</h3>
        <div id="totalCount" class="text-3xl font-bold text-sky-700">‚Äî</div>
      </div>
      <div class="p-6 bg-yellow-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Pending</h3>
        <div id="pendingCount" class="text-3xl font-bold text-yellow-600">‚Äî</div>
      </div>
      <div class="p-6 bg-green-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Confirmed</h3>
        <div id="confirmedCount" class="text-3xl font-bold text-green-700">‚Äî</div>
      </div>
      <div class="p-6 bg-gray-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Vacant Rooms</h3>
        <div id="vacantCount" class="text-3xl font-bold text-gray-700">‚Äî</div>
      </div>
      <div class="p-6 bg-emerald-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Revenue (‚Çπ)</h3>
        <div id="revenueCount" class="text-3xl font-bold text-emerald-700">‚Äî</div>
      </div>
    </div>

    <!-- üìä Charts -->
    <section class="bg-gray-50 p-6 rounded-lg mb-10 border">
      <h2 id="chartTitle" class="text-xl font-semibold mb-4">üìä Occupancy Snapshot</h2>
      <canvas id="occupancyChart" height="120"></canvas>
    </section>

    <section class="bg-white p-6 rounded-lg shadow border mb-10">
      <h2 class="text-xl font-semibold mb-4">üìà Occupancy Trend Over Time</h2>
      <canvas id="trendChart" height="120"></canvas>
    </section>

    <section class="bg-white p-6 rounded-lg shadow border mb-10">
      <h2 class="text-xl font-semibold mb-4">üí∞ Revenue Trend (‚Çπ/Day)</h2>
      <canvas id="revenueChart" height="120"></canvas>
    </section>

    <!-- üïì Recent Bookings -->
    <section class="bg-white p-6 rounded-lg shadow border">
      <h2 class="text-xl font-semibold mb-4">üïì Recent Bookings</h2>
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="border-b bg-gray-100 text-left">
            <th class="py-2 px-3">Guest</th>
            <th class="py-2 px-3">Room</th>
            <th class="py-2 px-3">Dates</th>
            <th class="py-2 px-3 text-center">Status</th>
          </tr>
        </thead>
        <tbody id="recentBookings"></tbody>
      </table>
    </section>
  </section>

  <!-- Owner Settings: Change Password -->
  <section id="ownerSettings" class="max-w-6xl mx-auto p-8 bg-white rounded-2xl shadow mt-4">
    <h2 class="text-2xl font-semibold mb-4">Owner Settings</h2>
    <p class="text-gray-600 mb-4">Change the admin password for login.</p>
    <form id="changePasswordForm" class="space-y-4 max-w-md">
      <div>
        <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
        <input id="newPassword" name="newPassword" type="password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <div>
        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password</label>
        <input id="confirmPassword" name="confirmPassword" type="password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded hover:bg-sky-700">Update Password</button>
      <div id="pwStatus" class="hidden mt-3 p-3 rounded text-sm"></div>
    </form>
  </section>
</AdminLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('changePasswordForm');
    const statusEl = document.getElementById('pwStatus');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.classList.add('hidden');
      statusEl.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if (newPassword !== confirmPassword) {
        statusEl.textContent = 'Passwords do not match';
        statusEl.classList.add('bg-red-100', 'text-red-700');
        statusEl.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ new_password: newPassword })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.success) {
          statusEl.textContent = 'Password updated successfully';
          statusEl.classList.add('bg-green-100', 'text-green-700');
          statusEl.classList.remove('hidden');
          form.reset();
        } else {
          statusEl.textContent = data.error || 'Failed to update password';
          statusEl.classList.add('bg-red-100', 'text-red-700');
          statusEl.classList.remove('hidden');
        }
      } catch (err) {
        statusEl.textContent = err.message || 'Error updating password';
        statusEl.classList.add('bg-red-100', 'text-red-700');
        statusEl.classList.remove('hidden');
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script client:load>
  const { jsPDF } = window.jspdf;

  // Setup logout functionality
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      const response = await fetch('/api/admin-auth', {
        method: 'DELETE'
      });
      
      if (response.ok) {
        window.location.href = '/admin/login';
      } else {
        alert('Logout failed. Please try again.');
      }
    } catch (error) {
      console.error('Logout error:', error);
      alert('An error occurred during logout.');
    }
  });

  // Generate PDF with multiple pages and custom branding
  async function generatePDF() {
    const pdf = new jsPDF('p', 'mm', 'a4');
    const report = document.getElementById('reportArea');
    const logoUrl = '/uploader/logo-512.webp';
    const start = document.getElementById('startDate').value || '‚Äî';
    const end = document.getElementById('endDate').value || '‚Äî';
    const dateRange = (start !== '‚Äî' || end !== '‚Äî') ? `${start} ‚Üí ${end}` : "All Data";

    // 1Ô∏è‚É£ Header Page
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(22);
    pdf.text("üè® Dolphin House Beach Resort", 20, 40);
    pdf.setFontSize(14);
    pdf.setTextColor(60);
    pdf.text("Admin Performance Report", 20, 55);
    pdf.setFontSize(12);
    pdf.text(`Date Range: ${dateRange}`, 20, 70);
    pdf.text(`Generated on: ${new Date().toLocaleString()}`, 20, 80);
    pdf.addImage(logoUrl, 'WEBP', 150, 20, 40, 40);
    pdf.setLineWidth(0.5);
    pdf.line(20, 90, 190, 90);
    pdf.text("Summary and Analytics Overview", 20, 100);
    pdf.addPage();

    // 2Ô∏è‚É£ Summary Page
    const summaryCanvas = await html2canvas(document.getElementById('summary'), { scale: 2 });
    const summaryImg = summaryCanvas.toDataURL('image/png');
    const width = 190;
    const height = (summaryCanvas.height * width) / summaryCanvas.width;
    pdf.addImage(summaryImg, 'PNG', 10, 20, width, height);
    pdf.text("Booking & Revenue Summary", 20, 15);
    pdf.addPage();

    // 3Ô∏è‚É£ Charts Page
    const charts = ['occupancyChart', 'trendChart', 'revenueChart'];
    for (let i = 0; i < charts.length; i++) {
      const chart = document.getElementById(charts[i]);
      if (chart) {
        const chartCanvas = await html2canvas(chart, { scale: 2 });
        const imgData = chartCanvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 10, 20, 190, 110);
        pdf.text(chart.parentElement.querySelector('h2').innerText, 20, 15);
        if (i < charts.length - 1) pdf.addPage();
      }
    }

    // 4Ô∏è‚É£ Recent Bookings Table
    const table = document.querySelector('#recentBookings').closest('section');
    const tableCanvas = await html2canvas(table, { scale: 2 });
    const tableImg = tableCanvas.toDataURL('image/png');
    pdf.addImage(tableImg, 'PNG', 10, 20, 190, (tableCanvas.height * 190) / tableCanvas.width);

    // Footer & Page Numbers
    const pageCount = pdf.internal.getNumberOfPages();
    pdf.setFontSize(9);
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.text(`Page ${i} of ${pageCount}`, 180, 290, { align: "right" });
      pdf.text("¬© Dolphin House Beach Resort", 20, 290);
    }

    pdf.save(`DolphinHouse_Report_${Date.now()}.pdf`);
  }

  document.getElementById('downloadPdfBtn').addEventListener('click', generatePDF);
  
  // Banner dismiss logic
  const cpBanner = document.getElementById('cpBanner');
  const dismissCpBanner = document.getElementById('dismissCpBanner');
  if (cpBanner) {
    try {
      const dismissed = localStorage.getItem('cpBannerDismissed') === '1';
      if (dismissed) cpBanner.style.display = 'none';
      dismissCpBanner?.addEventListener('click', () => {
        localStorage.setItem('cpBannerDismissed', '1');
        cpBanner.style.display = 'none';
      });
    } catch {}
  }
</script>
