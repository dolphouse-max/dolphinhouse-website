---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminHeader from '../../components/AdminHeader.astro';
import { isAuthenticated } from '../../middleware/auth.js';

// Check if user is authenticated
const authenticated = await isAuthenticated(Astro);
if (!authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Admin Dashboard | Dolphin House">
  <AdminHeader />

  <!-- üîê Change Password Banner (dismissible) -->
  <section id="changePasswordBanner" class="max-w-6xl mx-auto mt-4 px-4">
    <div id="cpBanner" class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded-lg flex items-center justify-between">
      <span class="text-sm">For security, please update your admin password.</span>
      <div class="flex gap-2">
        <a href="/admin/change-password" class="px-3 py-1 bg-sky-600 text-white rounded hover:bg-sky-700 text-sm">Change Password</a>
        <button id="dismissCpBanner" class="px-3 py-1 border rounded text-sm">Dismiss</button>
      </div>
    </div>
  </section>

  <section id="reportArea" class="max-w-6xl mx-auto p-8 bg-white rounded-2xl shadow-lg mt-10 mb-16">
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center gap-4">
        <img src="/uploader/logo-512.webp" alt="Logo" class="w-12 h-12 rounded-full border shadow">
        <div>
          <h1 class="text-3xl font-bold text-sky-700">üè® Dolphin House Admin Dashboard</h1>
          <p class="text-gray-600">Bookings, Occupancy, and Revenue Insights</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="downloadPdfBtn" class="bg-rose-600 hover:bg-rose-700 text-white px-5 py-2 rounded-lg shadow">
          üì• Download PDF Report
        </button>
        <a href="/admin/change-password" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg shadow">
          üîê Change Password
        </a>
      </div>
    </div>

    <!-- üóì Filters -->
    <div class="flex flex-wrap justify-center items-center gap-4 mb-8">
      <div class="flex gap-2">
        <button class="filter-btn bg-sky-600 text-white px-4 py-2 rounded" data-filter="today">Today</button>
        <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" data-filter="week">This Week</button>
        <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" data-filter="month">This Month</button>
      </div>
      <div class="flex items-center gap-2">
        <input id="startDate" type="date" class="border rounded px-3 py-2" />
        <span>‚Üí</span>
        <input id="endDate" type="date" class="border rounded px-3 py-2" />
        <button id="applyRangeBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Apply</button>
      </div>
    </div>

    <!-- ‚úÖ Summary Cards -->
    <div id="summary" class="grid sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-10">
      <div class="p-6 bg-sky-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Bookings</h3>
        <div id="totalCount" class="text-3xl font-bold text-sky-700">‚Äî</div>
      </div>
      <div class="p-6 bg-yellow-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Pending</h3>
        <div id="pendingCount" class="text-3xl font-bold text-yellow-600">‚Äî</div>
      </div>
      <div class="p-6 bg-green-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Confirmed</h3>
        <div id="confirmedCount" class="text-3xl font-bold text-green-700">‚Äî</div>
      </div>
      <div class="p-6 bg-gray-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Vacant Rooms</h3>
        <div id="vacantCount" class="text-3xl font-bold text-gray-700">‚Äî</div>
      </div>
      <div class="p-6 bg-emerald-50 rounded-xl text-center border">
        <h3 class="text-gray-700 text-sm font-medium mb-1">Revenue (‚Çπ)</h3>
        <div id="revenueCount" class="text-3xl font-bold text-emerald-700">‚Äî</div>
      </div>
    </div>

    <!-- üìä Charts -->
    <section class="bg-gray-50 p-6 rounded-lg mb-10 border">
      <h2 id="chartTitle" class="text-xl font-semibold mb-4">üìä Occupancy Snapshot</h2>
      <canvas id="occupancyChart" height="120"></canvas>
    </section>

    <section class="bg-white p-6 rounded-lg shadow border mb-10">
      <h2 class="text-xl font-semibold mb-4">üìà Occupancy Trend Over Time</h2>
      <canvas id="trendChart" height="120"></canvas>
    </section>

    <section class="bg-white p-6 rounded-lg shadow border mb-10">
      <h2 class="text-xl font-semibold mb-4">üí∞ Revenue Trend (‚Çπ/Day)</h2>
      <canvas id="revenueChart" height="120"></canvas>
    </section>

    <!-- üïì Recent Bookings -->
    <section class="bg-white p-6 rounded-lg shadow border">
      <h2 class="text-xl font-semibold mb-4">üïì Recent Bookings</h2>
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="border-b bg-gray-100 text-left">
            <th class="py-2 px-3">Guest</th>
            <th class="py-2 px-3">Room</th>
            <th class="py-2 px-3">Dates</th>
            <th class="py-2 px-3 text-center">Status</th>
          </tr>
        </thead>
        <tbody id="recentBookings"></tbody>
      </table>
    </section>
  </section>

  <!-- Owner Settings: Change Password -->
  <section id="ownerSettings" class="max-w-6xl mx-auto p-8 bg-white rounded-2xl shadow mt-4">
    <h2 class="text-2xl font-semibold mb-4">Owner Settings</h2>
    <p class="text-gray-600 mb-4">Change the admin password for login.</p>
    <form id="changePasswordForm" class="space-y-4 max-w-md">
      <div>
        <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
        <input id="newPassword" name="newPassword" type="password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <div>
        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password</label>
        <input id="confirmPassword" name="confirmPassword" type="password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded hover:bg-sky-700">Update Password</button>
      <div id="pwStatus" class="hidden mt-3 p-3 rounded text-sm"></div>
    </form>

    <hr class="my-8" />
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="p-4 border rounded-lg bg-gray-50">
        <h3 class="text-lg font-semibold mb-2">Global Booking Availability</h3>
        <p class="text-sm text-gray-600 mb-3">Toggle whether visitors can book rooms on the website.</p>
        <div class="flex items-center gap-3">
          <span id="bookingStatusLabel" class="px-2 py-1 rounded text-sm bg-green-100 text-green-700 hidden">Enabled</span>
          <span id="bookingStatusLabelOff" class="px-2 py-1 rounded text-sm bg-yellow-100 text-yellow-800 hidden">Paused</span>
          <button id="toggleBookingsBtn" class="px-4 py-2 bg-sky-600 text-white rounded hover:bg-sky-700">Toggle Bookings</button>
        </div>
        <div id="bookingToggleMsg" class="hidden mt-3 p-2 rounded text-sm"></div>
        <div class="mt-4">
          <label for="bookingNoticeInput" class="block text-sm font-medium text-gray-700 mb-1">Pause Notice Message</label>
          <textarea id="bookingNoticeInput" rows="3" class="w-full px-3 py-2 border rounded" placeholder="e.g. Bookings are paused due to maintenance until 15 Dec."></textarea>
          <div class="mt-2 flex gap-2">
            <button id="saveBookingNoticeBtn" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Save Message</button>
            <div id="bookingNoticeMsg" class="hidden p-2 rounded text-sm"></div>
          </div>
        </div>
        <div class="mt-4">
          <div class="text-sm font-medium text-gray-700 mb-1">Contact Details (shown on booking page when paused)</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="block">
              <span class="text-xs text-gray-600">Phone 1 (E.164)</span>
              <input id="bookingPhone1" class="w-full px-3 py-2 border rounded" placeholder="+918554871073" />
            </label>
            <label class="block">
              <span class="text-xs text-gray-600">Phone 2 (E.164)</span>
              <input id="bookingPhone2" class="w-full px-3 py-2 border rounded" placeholder="+917276171735" />
            </label>
            <label class="block">
              <span class="text-xs text-gray-600">WhatsApp (E.164)</span>
              <input id="bookingWhatsapp" class="w-full px-3 py-2 border rounded" placeholder="+918554871073" />
            </label>
            <label class="block">
              <span class="text-xs text-gray-600">Email</span>
              <input id="bookingEmail" type="email" class="w-full px-3 py-2 border rounded" placeholder="booking@dolphinhouse-alibaug.com" />
            </label>
          </div>
          <div class="mt-2 flex gap-2">
            <button id="saveBookingContactsBtn" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Save Contacts</button>
            <div id="bookingContactsMsg" class="hidden p-2 rounded text-sm"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</AdminLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('changePasswordForm');
    const statusEl = document.getElementById('pwStatus');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.classList.add('hidden');
      statusEl.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if (newPassword !== confirmPassword) {
        statusEl.textContent = 'Passwords do not match';
        statusEl.classList.add('bg-red-100', 'text-red-700');
        statusEl.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/admin-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ new_password: newPassword })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.success) {
          statusEl.textContent = 'Password updated successfully';
          statusEl.classList.add('bg-green-100', 'text-green-700');
          statusEl.classList.remove('hidden');
          form.reset();
        } else {
          statusEl.textContent = data.error || 'Failed to update password';
          statusEl.classList.add('bg-red-100', 'text-red-700');
          statusEl.classList.remove('hidden');
        }
      } catch (err) {
        statusEl.textContent = err.message || 'Error updating password';
        statusEl.classList.add('bg-red-100', 'text-red-700');
        statusEl.classList.remove('hidden');
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

<!-- Dashboard data fetch and render -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const elTotal = document.getElementById('totalCount');
    const elPending = document.getElementById('pendingCount');
    const elConfirmed = document.getElementById('confirmedCount');
    const elVacant = document.getElementById('vacantCount');
    const elRevenue = document.getElementById('revenueCount');
    const recentTbody = document.getElementById('recentBookings');
    const chartTitle = document.getElementById('chartTitle');
    const occCanvas = document.getElementById('occupancyChart');
    const trendCanvas = document.getElementById('trendChart');
    const revCanvas = document.getElementById('revenueChart');

    let occChart = null;
    let trendChart = null;
    let revenueChart = null;

    const fetchJSON = async (url) => {
      try {
        const res = await fetch(`${url}${url.includes('?') ? '&' : '?'}ts=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.warn('Fetch failed', url, e);
        return [];
      }
    };

    const isoDate = (d) => {
      const dt = (d instanceof Date) ? d : new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, '0');
      const day = String(dt.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    };

    const dateRange = (start, end) => {
      const s = (start instanceof Date) ? start : new Date(start);
      const e = (end instanceof Date) ? end : new Date(end);
      const arr = [];
      const cur = new Date(s);
      while (cur <= e) {
        arr.push(isoDate(cur));
        cur.setDate(cur.getDate() + 1);
      }
      return arr;
    };

    const rangesOverlap = (aStart, aEnd, bStart, bEnd) => {
      return aStart < bEnd && bStart < aEnd;
    };

    const countBookedOnDate = (bookings, roomType, ymd) => {
      const start = new Date(ymd);
      const end = new Date(ymd); end.setDate(end.getDate() + 1);
      let c = 0;
      bookings.forEach(b => {
        if (!b || b.status === 'cancelled') return;
        if (roomType && b.room !== roomType) return;
        const bi = new Date(b.checkin), bo = new Date(b.checkout);
        if (rangesOverlap(start, end, bi, bo)) c++;
      });
      return c;
    };

    const sumRevenueByDate = (bookings, ymd) => {
      const start = new Date(ymd);
      const end = new Date(ymd); end.setDate(end.getDate() + 1);
      let sum = 0;
      bookings.forEach(b => {
        if (!b || b.status === 'cancelled') return;
        const bi = new Date(b.checkin), bo = new Date(b.checkout);
        if (rangesOverlap(start, end, bi, bo)) sum += Number(b.total || 0);
      });
      return sum;
    };

    async function loadDashboard(rangeStart, rangeEnd) {
      const [bookings, inventoryArr] = await Promise.all([
        fetchJSON('/api/bookings'),
        fetchJSON('/api/inventory')
      ]);

      const inventory = Array.isArray(inventoryArr)
        ? inventoryArr.reduce((acc, it) => { if (it?.room) acc[it.room] = it; return acc; }, {})
        : (inventoryArr || {});

      // Summary counts
      const totalCount = Array.isArray(bookings) ? bookings.length : 0;
      const pendingCount = bookings.filter(b => (b?.status || '').toLowerCase() === 'pending').length;
      const confirmedCount = bookings.filter(b => (b?.status || '').toLowerCase() === 'confirmed').length;

      // Determine date range
      let end = rangeEnd ? new Date(rangeEnd) : new Date();
      let start = rangeStart ? new Date(rangeStart) : new Date(end);
      if (!rangeStart) start.setDate(end.getDate() - 29); // default last 30 days
      const days = dateRange(start, end);

      // Vacant rooms: compute snapshot for end date across all room types
      const today = isoDate(end);
      const vacantTotal = Object.keys(inventory).reduce((sum, room) => {
        const qty = Number(inventory[room]?.qty || 0);
        const booked = countBookedOnDate(bookings, room, today);
        return sum + Math.max(0, qty - booked);
      }, 0);

      // Revenue: sum across active bookings (confirmed/approved) in selected range
      const allowedStatuses = new Set(['confirmed', 'approved']);
      const activeBookings = bookings.filter(b => allowedStatuses.has((b?.status || '').toLowerCase()));
      const dailyRevenue = days.map(d => sumRevenueByDate(activeBookings, d));
      const revenueTotal = dailyRevenue.reduce((a, b) => a + b, 0);

      elTotal.textContent = String(totalCount);
      elPending.textContent = String(pendingCount);
      elConfirmed.textContent = String(confirmedCount);
      elVacant.textContent = String(vacantTotal);
      elRevenue.textContent = String(Math.round(revenueTotal));

      // Recent bookings table
      recentTbody.innerHTML = '';
      const recent = bookings
        .slice()
        .sort((a, b) => new Date(b.createdAt || b.created_at || 0) - new Date(a.createdAt || a.created_at || 0))
        .slice(0, 10);
      recent.forEach(b => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        const dates = `${b.checkin} ‚Üí ${b.checkout}`;
        const status = (b.status || '').toUpperCase();
        tr.innerHTML = `
          <td class="py-2 px-3">${b.name || ''}</td>
          <td class="py-2 px-3">${b.room || ''}</td>
          <td class="py-2 px-3">${dates}</td>
          <td class="py-2 px-3 text-center">${status}</td>
        `;
        recentTbody.appendChild(tr);
      });

      // Charts
      if (chartTitle) chartTitle.textContent = `üìä Occupancy Snapshot (${today})`;

      // Occupancy snapshot by room
      const rooms = Object.keys(inventory);
      const avail = rooms.map(room => {
        const qty = Number(inventory[room]?.qty || 0);
        const booked = countBookedOnDate(bookings, room, today);
        return Math.max(0, qty - booked);
      });

      if (occChart) occChart.destroy();
      if (occCanvas) {
        occChart = new Chart(occCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: rooms,
            datasets: [{
              label: 'Vacant Today',
              data: avail,
              backgroundColor: '#38bdf8'
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }

      // Trend chart: bookings per day (selected range)
      const dailyBookings = days.map(d => {
        return bookings.filter(b => {
          const bi = new Date(b.checkin), bo = new Date(b.checkout);
          const ds = new Date(d), de = new Date(d); de.setDate(de.getDate() + 1);
          return rangesOverlap(ds, de, bi, bo);
        }).length;
      });

      if (trendChart) trendChart.destroy();
      if (trendCanvas) {
        trendChart = new Chart(trendCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: days.map(d => d.slice(5)),
            datasets: [{
              label: 'Bookings per Day',
              data: dailyBookings,
              borderColor: '#0ea5e9',
              backgroundColor: 'rgba(14,165,233,0.2)'
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }

      // Revenue chart: daily revenue (confirmed/approved)
      if (revenueChart) revenueChart.destroy();
      if (revCanvas) {
        revenueChart = new Chart(revCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: days.map(d => d.slice(5)),
            datasets: [{
              label: 'Revenue per Day (‚Çπ)',
              data: dailyRevenue.map(v => Math.round(v)),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16,185,129,0.2)'
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }
    }

    // Filters: Today / Week / Month buttons
    const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');

    function setActiveButton(val) {
      filterButtons.forEach(b => {
        const isActive = b.dataset.filter === val;
        b.classList.toggle('bg-sky-600', isActive);
        b.classList.toggle('text-white', isActive);
        b.classList.toggle('bg-gray-200', !isActive);
      });
    }

    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const f = btn.dataset.filter;
        const today = isoDate(new Date());
        if (f === 'today') {
          startInput.value = today;
          endInput.value = today;
          setActiveButton('today');
          loadDashboard(today, today);
        } else if (f === 'week') {
          const end = today;
          const start = isoDate(new Date(new Date().setDate(new Date().getDate() - 6)));
          startInput.value = start;
          endInput.value = end;
          setActiveButton('week');
          loadDashboard(start, end);
        } else if (f === 'month') {
          const end = today;
          const start = isoDate(new Date(new Date().setDate(new Date().getDate() - 29)));
          startInput.value = start;
          endInput.value = end;
          setActiveButton('month');
          loadDashboard(start, end);
        }
      });
    });

    // Apply custom range
    document.getElementById('applyRangeBtn')?.addEventListener('click', () => {
      const s = startInput.value;
      const e = endInput.value;
      if (!s || !e) return loadDashboard();
      if (new Date(s) > new Date(e)) return alert('Start date must be before end date');
      setActiveButton('');
      loadDashboard(s, e);
    });

    // Initial load (default last 30 days)
    loadDashboard();
  });
</script>

<script client:load>
  // Safely reference jsPDF when available; avoid crashing if not loaded yet
  let jsPDF = window.jspdf?.jsPDF;

  // Setup logout functionality
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      const response = await fetch('/api/admin-auth', {
        method: 'DELETE'
      });
      
      if (response.ok) {
        window.location.href = '/admin/login';
      } else {
        alert('Logout failed. Please try again.');
      }
    } catch (error) {
      console.error('Logout error:', error);
      alert('An error occurred during logout.');
    }
  });

  // Generate PDF with multiple pages and custom branding
  async function generatePDF() {
    // If jsPDF is not yet available, attempt to grab it again; otherwise inform user
    jsPDF = jsPDF || window.jspdf?.jsPDF;
    if (!jsPDF) {
      alert('PDF export is unavailable right now. Please try again in a few seconds.');
      return;
    }
    const pdf = new jsPDF('p', 'mm', 'a4');
    const report = document.getElementById('reportArea');
    const logoUrl = '/uploader/logo-512.png';
    const start = document.getElementById('startDate').value || '‚Äî';
    const end = document.getElementById('endDate').value || '‚Äî';
    const dateRange = (start !== '‚Äî' || end !== '‚Äî') ? `${start} ‚Üí ${end}` : "All Data";

    // 1Ô∏è‚É£ Header Page
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(22);
    pdf.text("üè® Dolphin House Beach Resort", 20, 40);
    pdf.setFontSize(14);
    pdf.setTextColor(60);
    pdf.text("Admin Performance Report", 20, 55);
    pdf.setFontSize(12);
    pdf.text(`Date Range: ${dateRange}`, 20, 70);
    pdf.text(`Generated on: ${new Date().toLocaleString()}`, 20, 80);
    pdf.addImage(logoUrl, 'PNG', 150, 20, 40, 40);
    pdf.setLineWidth(0.5);
    pdf.line(20, 90, 190, 90);
    pdf.text("Summary and Analytics Overview", 20, 100);
    pdf.addPage();

    // 2Ô∏è‚É£ Summary Page
    const summaryCanvas = await html2canvas(document.getElementById('summary'), { scale: 2 });
    const summaryImg = summaryCanvas.toDataURL('image/png');
    const width = 190;
    const height = (summaryCanvas.height * width) / summaryCanvas.width;
    pdf.addImage(summaryImg, 'PNG', 10, 20, width, height);
    pdf.text("Booking & Revenue Summary", 20, 15);
    pdf.addPage();

    // 3Ô∏è‚É£ Charts Page
    const charts = ['occupancyChart', 'trendChart', 'revenueChart'];
    for (let i = 0; i < charts.length; i++) {
      const chart = document.getElementById(charts[i]);
      if (chart) {
        const chartCanvas = await html2canvas(chart, { scale: 2 });
        const imgData = chartCanvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 10, 20, 190, 110);
        pdf.text(chart.parentElement.querySelector('h2').innerText, 20, 15);
        if (i < charts.length - 1) pdf.addPage();
      }
    }

    // 4Ô∏è‚É£ Recent Bookings Table
    const table = document.querySelector('#recentBookings').closest('section');
    const tableCanvas = await html2canvas(table, { scale: 2 });
    const tableImg = tableCanvas.toDataURL('image/png');
    pdf.addImage(tableImg, 'PNG', 10, 20, 190, (tableCanvas.height * 190) / tableCanvas.width);

    // Footer & Page Numbers
    const pageCount = pdf.internal.getNumberOfPages();
    pdf.setFontSize(9);
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.text(`Page ${i} of ${pageCount}`, 180, 290, { align: "right" });
      pdf.text("¬© Dolphin House Beach Resort", 20, 290);
    }

    pdf.save(`DolphinHouse_Report_${Date.now()}.pdf`);
  }

  document.getElementById('downloadPdfBtn').addEventListener('click', generatePDF);
  
  // Banner dismiss logic
  const cpBanner = document.getElementById('cpBanner');
  const dismissCpBanner = document.getElementById('dismissCpBanner');
  if (cpBanner) {
    try {
      const dismissed = localStorage.getItem('cpBannerDismissed') === '1';
      if (dismissed) cpBanner.style.display = 'none';
      dismissCpBanner?.addEventListener('click', () => {
        localStorage.setItem('cpBannerDismissed', '1');
        cpBanner.style.display = 'none';
      });
    } catch {}
  }

  // Booking toggle control
  async function refreshBookingToggleUI() {
    const labelOn = document.getElementById('bookingStatusLabel');
    const labelOff = document.getElementById('bookingStatusLabelOff');
    const btn = document.getElementById('toggleBookingsBtn');
    const msg = document.getElementById('bookingToggleMsg');
    const noticeInput = document.getElementById('bookingNoticeInput');
    const phone1Input = document.getElementById('bookingPhone1');
    const phone2Input = document.getElementById('bookingPhone2');
    const whatsappInput = document.getElementById('bookingWhatsapp');
    const emailInput = document.getElementById('bookingEmail');
    try {
      const res = await fetch('/api/booking-toggle', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const enabled = !!data?.bookingEnabled;
      labelOn.classList.toggle('hidden', !enabled);
      labelOff.classList.toggle('hidden', enabled);
      btn.textContent = enabled ? 'Pause Bookings' : 'Enable Bookings';
      btn.classList.toggle('bg-sky-600', enabled);
      btn.classList.toggle('bg-green-600', !enabled);
      btn.classList.toggle('hover:bg-sky-700', enabled);
      btn.classList.toggle('hover:bg-green-700', !enabled);
      // Show current status message prominently
      msg.textContent = enabled ? 'Bookings enabled' : 'Bookings paused';
      msg.classList.remove('hidden');
      msg.classList.remove('bg-red-100', 'text-red-700');
      msg.classList.add('bg-green-100', 'text-green-700');
      if (noticeInput && typeof data?.notice === 'string') {
        noticeInput.value = data.notice;
      }
      const c = data?.contact || {};
      if (phone1Input) phone1Input.value = c.phone1 || '';
      if (phone2Input) phone2Input.value = c.phone2 || '';
      if (whatsappInput) whatsappInput.value = c.whatsapp || '';
      if (emailInput) emailInput.value = c.email || '';
      // Ensure button is enabled after status refresh
      btn.disabled = false;
    } catch (e) {
      msg.textContent = 'Failed to load booking status';
      msg.classList.remove('hidden');
      msg.classList.add('bg-red-100', 'text-red-700');
      // Ensure the button is usable even if fetch fails
      btn.textContent = 'Enable Bookings';
      btn.classList.add('bg-green-600');
      btn.classList.add('hover:bg-green-700');
      btn.classList.remove('bg-sky-600');
      btn.classList.remove('hover:bg-sky-700');
      btn.disabled = false;
    }
  }

  async function toggleBookings() {
    const btn = document.getElementById('toggleBookingsBtn');
    const msg = document.getElementById('bookingToggleMsg');
    btn.disabled = true;
    const currentlyEnabled = !document.getElementById('bookingStatusLabel').classList.contains('hidden');
    try {
      const res = await fetch('/api/booking-toggle', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bookingEnabled: !currentlyEnabled })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      msg.textContent = data.bookingEnabled ? 'Bookings enabled' : 'Bookings paused';
      msg.classList.remove('hidden');
      msg.classList.remove('bg-red-100', 'text-red-700');
      msg.classList.add('bg-green-100', 'text-green-700');
      await refreshBookingToggleUI();
    } catch (e) {
      msg.textContent = String(e.message || e);
      msg.classList.remove('hidden');
      msg.classList.remove('bg-green-100', 'text-green-700');
      msg.classList.add('bg-red-100', 'text-red-700');
    } finally {
      btn.disabled = false;
    }
  }

  // Attach listeners after DOM is ready
  function initBookingControls() {
    const toggleBtn = document.getElementById('toggleBookingsBtn');
    if (toggleBtn) {
      toggleBtn.disabled = false; // Always enable on load
      toggleBtn.addEventListener('click', toggleBookings);
    }
    const saveNoticeBtn = document.getElementById('saveBookingNoticeBtn');
    if (saveNoticeBtn) saveNoticeBtn.addEventListener('click', saveBookingNotice);
    const saveContactsBtn = document.getElementById('saveBookingContactsBtn');
    if (saveContactsBtn) saveContactsBtn.addEventListener('click', saveBookingContacts);
    refreshBookingToggleUI();
  }
  
  async function saveBookingNotice() {
    const noticeInput = document.getElementById('bookingNoticeInput');
    const msg = document.getElementById('bookingNoticeMsg');
    msg.classList.add('hidden');
    msg.classList.remove('bg-green-100','text-green-700','bg-red-100','text-red-700');
    const notice = noticeInput.value.trim();
    try {
      const res = await fetch('/api/booking-toggle', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notice })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      msg.textContent = 'Message saved';
      msg.classList.add('bg-green-100','text-green-700');
      msg.classList.remove('hidden');
    } catch (e) {
      msg.textContent = String(e.message || e);
      msg.classList.add('bg-red-100','text-red-700');
      msg.classList.remove('hidden');
    }
  }

  // moved into initBookingControls()

  async function saveBookingContacts() {
    const msg = document.getElementById('bookingContactsMsg');
    const phone1 = document.getElementById('bookingPhone1').value.trim();
    const phone2 = document.getElementById('bookingPhone2').value.trim();
    const whatsapp = document.getElementById('bookingWhatsapp').value.trim();
    const email = document.getElementById('bookingEmail').value.trim();
    msg.classList.add('hidden');
    msg.classList.remove('bg-green-100','text-green-700','bg-red-100','text-red-700');
    try {
      const res = await fetch('/api/booking-toggle', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contact: { phone1, phone2, whatsapp, email } })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      msg.textContent = 'Contacts saved';
      msg.classList.add('bg-green-100','text-green-700');
      msg.classList.remove('hidden');
    } catch (e) {
      msg.textContent = String(e.message || e);
      msg.classList.add('bg-red-100','text-red-700');
      msg.classList.remove('hidden');
    }
  }

  // Initialize immediately if DOM is ready; otherwise wait for DOMContentLoaded
  if (document.readyState !== 'loading') {
    initBookingControls();
  } else {
    document.addEventListener('DOMContentLoaded', initBookingControls);
  }
</script>
