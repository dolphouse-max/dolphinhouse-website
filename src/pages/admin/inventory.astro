---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminHeader from '../../components/AdminHeader.astro';
import { isAuthenticated } from '../../middleware/auth.js';

// Check if user is authenticated
const authenticated = await isAuthenticated(Astro);
if (!authenticated) {
  return Astro.redirect('/admin/login');
}
---
<AdminLayout title="Inventory | Dolphin House">
  <AdminHeader />
  <div class="max-w-7xl mx-auto px-4 py-6">

  <section class="max-w-7xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Room Inventory & Rates</h1>
      <div class="flex gap-3">
        <button id="addRoomBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Add Room</button>
        <button id="saveBtn" class="px-4 py-2 bg-sky-600 text-white rounded">Save Changes</button>
        <button id="refreshInventory" class="px-4 py-2 border rounded">Refresh</button>
      </div>
    </div>
    
    <!-- Room Inventory Modal -->
    <div id="roomModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h3 id="modalTitle" class="text-xl font-semibold">Add Room</h3>
          <button id="closeModal" class="text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <form id="roomForm" class="space-y-4">
          <input type="hidden" id="editMode" value="false">
          
          <div>
            <label for="roomId" class="block text-sm font-medium text-gray-700">Room ID</label>
            <input type="text" id="roomId" name="roomId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
            <p class="text-xs text-gray-500 mt-1">Unique identifier for the room (e.g., deluxe1, standard2)</p>
          </div>
          
          <div>
            <label for="roomLabel" class="block text-sm font-medium text-gray-700">Room Label</label>
            <input type="text" id="roomLabel" name="roomLabel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
            <p class="text-xs text-gray-500 mt-1">Display name for the room (e.g., Deluxe Room, Standard Room)</p>
          </div>
          
          <div>
            <label for="roomQty" class="block text-sm font-medium text-gray-700">Quantity</label>
            <input type="number" id="roomQty" name="roomQty" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="rateNonAC" class="block text-sm font-medium text-gray-700">Non-AC Rate (₹)</label>
              <input type="number" id="rateNonAC" name="rateNonAC" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            
            <div>
              <label for="rateAC" class="block text-sm font-medium text-gray-700">AC Rate (₹)</label>
              <input type="number" id="rateAC" name="rateAC" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
          </div>
          
          <div class="flex justify-end gap-2 pt-4">
            <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Room</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-6 items-end">
      <div>
        <label class="text-sm font-medium text-gray-700">Select Date</label><br/>
        <input id="dateSelect" type="date" class="border px-3 py-2 rounded">
      </div>
      <div>
        <button id="loadChartBtn" class="px-4 py-2 border rounded">Show Occupancy</button>
      </div>
      <div>
        <label class="text-sm text-gray-600">Chart Range</label><br/>
        <select id="chartRange" class="border px-2 py-1 rounded">
          <option value="1">1 day</option>
          <option value="3">3 days</option>
          <option value="7" selected>7 days</option>
        </select>
      </div>
    </div>

    <!-- Room Inventory Cards -->
    <div id="inventoryGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10"></div>

    <!-- Chart Section (hidden per request) -->
    <section class="bg-white p-6 rounded-lg shadow mb-8 hidden">
      <h2 class="text-xl font-semibold mb-4">Occupancy Chart</h2>
      <canvas id="occupancyChart" height="120"></canvas>
    </section>

    <!-- Monthly Availability Editor -->
    <section class="bg-white p-6 rounded-lg shadow mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Monthly Availability Editor</h3>
        <div class="flex items-center gap-2">
          <input id="monthPicker" type="month" class="border px-2 py-1 rounded" />
          <button id="loadMonthBtn" class="px-3 py-1 border rounded">Load Month</button>
          <button id="saveOverridesBtn" class="px-3 py-1 bg-sky-600 text-white rounded">Save Changes</button>
        </div>
      </div>
      <div class="flex items-center gap-3 mb-3">
        <label for="summaryDate" class="text-sm text-gray-700">Summary Date</label>
        <input id="summaryDate" type="date" class="border px-2 py-1 rounded" />
      </div>
      <div id="monthSummary" class="overflow-x-auto mb-4"></div>
      <div id="monthGrid" class="overflow-x-auto"></div>
    </section>

    <!-- Room Inventory Table (hidden per request) -->
    <section class="bg-white p-6 rounded-lg shadow mb-8 hidden">
      <h3 class="text-lg font-semibold mb-4">Room Inventory</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room Label</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Non-AC Rate (₹)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AC Rate (₹)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="inventoryTable" class="bg-white divide-y divide-gray-200">
            <!-- Room data will be loaded here -->
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading room inventory...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Availability Calendar (hidden per request) -->
    <section class="bg-white p-6 rounded-lg shadow hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Availability Calendar</h3>
        <div class="flex items-center gap-2">
          <button id="prevRange" class="px-3 py-1 border rounded">◀</button>
          <button id="nextRange" class="px-3 py-1 border rounded">▶</button>
          <select id="rangeDays" class="border px-2 py-1 rounded">
            <option value="7">7 days</option>
            <option value="14" selected>14 days</option>
            <option value="30">30 days</option>
          </select>
          <button id="reloadCalendar" class="px-3 py-1 border rounded">Reload</button>
        </div>
      </div>

      <div class="overflow-x-auto snap-x snap-mandatory" id="calendarWrap" style="scroll-behavior:smooth;">
        <div id="calendarGrid" class="inline-grid gap-1 p-2" style="grid-auto-flow:column;"></div>
      </div>

      <div id="legend" class="mt-3 text-sm text-gray-600">
        <span class="inline-flex items-center mr-4"><span class="w-4 h-4 bg-green-500 inline-block mr-2 rounded-sm"></span> Available</span>
        <span class="inline-flex items-center mr-4"><span class="w-4 h-4 bg-yellow-400 inline-block mr-2 rounded-sm"></span> Few Left</span>
        <span class="inline-flex items-center"><span class="w-4 h-4 bg-red-500 inline-block mr-2 rounded-sm"></span> Full</span>
      </div>
    </section>
  </section>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Main client script (runs in browser only) -->
  <script client:load>
  (async () => {
    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        const response = await fetch('/api/admin-auth', {
          method: 'DELETE'
        });
        
        if (response.ok) {
          window.location.href = '/admin/login';
        } else {
          alert('Logout failed. Please try again.');
        }
      } catch (error) {
        console.error('Logout error:', error);
        alert('An error occurred during logout.');
      }
    });
    
    // -----------------------
    // Config & defaults
    // -----------------------
    const DEFAULT_INVENTORY = {
      "standard": { label: "Standard Room", qty: 5, rateNonAC: 2000, rateAC: 2300, occupancy: 2, extraPerson: 700 },
      "deluxe": { label: "Deluxe Room", qty: 2, rateNonAC: 2300, rateAC: 2600, occupancy: 3, extraPerson: 700 },
      "family": { label: "Family Room", qty: 1, rateNonAC: 3000, rateAC: 3500, occupancy: 4, extraPerson: 700 },
      "deluxeFamily": { label: "Deluxe Family Room", qty: 1, rateNonAC: 3300, rateAC: 3800, occupancy: 4, extraPerson: 700 }
    };
    let inventory = DEFAULT_INVENTORY;
    
    // Room inventory CRUD operations
    const inventoryTable = document.getElementById('inventoryTable');
    const addRoomBtn = document.getElementById('addRoomBtn');
    const roomModal = document.getElementById('roomModal');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const roomForm = document.getElementById('roomForm');
    const modalTitle = document.getElementById('modalTitle');
    const roomIdInput = document.getElementById('roomId');
    const editModeInput = document.getElementById('editMode');

    // DOM
    const grid = document.getElementById('inventoryGrid');
    const saveBtn = document.getElementById('saveBtn');
    const refreshBtn = document.getElementById('refreshInventory');
    const dateSelect = document.getElementById('dateSelect');
    const loadChartBtn = document.getElementById('loadChartBtn');
    const chartCanvas = document.getElementById('occupancyChart');
    const chartRange = document.getElementById('chartRange');

    // Calendar DOM
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarWrap = document.getElementById('calendarWrap');
    const rangeSelect = document.getElementById('rangeDays');
    const prevBtn = document.getElementById('prevRange');
    const nextBtn = document.getElementById('nextRange');
    const reloadCalendarBtn = document.getElementById('reloadCalendar');

    let chartInstance = null;

    // ---------- UTIL helpers ----------
    function isoDate(d) {
      // return YYYY-MM-DD for Date or date-string
      const dt = (d instanceof Date) ? d : new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function parseYMD(y) {
      // create local date from YYYY-MM-DD
      const [yy, mm, dd] = y.split('-').map(Number);
      return new Date(yy, mm - 1, dd);
    }

    function addDays(date, n) {
      return new Date(date.getTime() + n * 24 * 60 * 60 * 1000);
    }

    function generateDates(startDate, days) {
      const arr = [];
      for (let i = 0; i < days; i++) arr.push(isoDate(addDays(startDate, i)));
      return arr;
    }

    // ---------- API helpers ----------
    async function fetchInventoryAPI() {
      try {
        const res = await fetch('/api/inventory');
        if (!res.ok) throw new Error('inventory API not available');
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if (!ct.includes('application/json')) {
          throw new Error('inventory API returned non-JSON');
        }
        const data = await res.json();
        // Normalize array response to object keyed by room
        if (Array.isArray(data)) {
          const obj = {};
          data.forEach(it => { if (it?.room) obj[it.room] = it; });
          return obj;
        }
        if (data && typeof data === 'object') return data;
      } catch (err) {
        console.warn('inventory API error, using defaults:', err.message);
      }
      return DEFAULT_INVENTORY;
    }

    async function fetchBookingsRange(startISO, endISO) {
      // endISO is exclusive
      try {
        const res = await fetch(`/api/bookings?start=${startISO}&end=${endISO}`);
        if (!res.ok) throw new Error('Bookings fetch failed');
        return await res.json();
      } catch (err) {
        console.error('fetchBookingsRange error', err);
        return [];
      }
    }

    // ---------- Inventory UI ----------
    function renderInventory() {
      grid.innerHTML = '';
      Object.keys(inventory).forEach(key => {
        const r = inventory[key];
        const div = document.createElement('div');
        div.className = 'bg-white rounded-lg shadow p-5 border hover:shadow-md transition';
        div.innerHTML = `
        <h3 class="text-lg font-bold mb-2">${r.label}</h3>

        <div class="mb-2 text-sm text-gray-600">Quantity:
          <input type="number" min="1" id="qty-${key}" value="${r.qty}" class="border px-2 py-1 w-20 ml-2 rounded">
        </div>

        <div class="mb-2 text-sm text-gray-600">Rate (Non-AC):
          <input type="number" id="rateNonAC-${key}" value="${r.rateNonAC}" class="border px-2 py-1 w-24 ml-2 rounded">
        </div>

        <div class="mb-2 text-sm text-gray-600">Rate (AC):
          <input type="number" id="rateAC-${key}" value="${r.rateAC}" class="border px-2 py-1 w-24 ml-2 rounded">
        </div>

        <div class="mb-2 text-sm text-gray-600">Occupancy:
          <input type="number" id="occupancy-${key}" value="${r.occupancy}" class="border px-2 py-1 w-20 ml-2 rounded">
        </div>

        <div class="text-sm text-gray-600">Extra Person Charge:
          <input type="number" id="extraPerson-${key}" value="${r.extraPerson}" class="border px-2 py-1 w-24 ml-2 rounded"> ₹
        </div>
      `;

        grid.appendChild(div);
      });
    }

    async function loadInventory() {
      inventory = await fetchInventoryAPI();
      renderInventory();
      renderInventoryTable();
    }

    async function saveInventory() {
      // read form values
      Object.keys(inventory).forEach(k => {
        const q = document.getElementById(`qty-${k}`);
        const r1 = document.getElementById(`rateNonAC-${k}`);
        const r2 = document.getElementById(`rateAC-${k}`);
        inventory[k].qty = parseInt(document.getElementById(`qty-${k}`).value);
        inventory[k].rateNonAC = parseFloat(document.getElementById(`rateNonAC-${k}`).value);
        inventory[k].rateAC = parseFloat(document.getElementById(`rateAC-${k}`).value);
        inventory[k].occupancy = parseInt(document.getElementById(`occupancy-${k}`).value);
        inventory[k].extraPerson = parseFloat(document.getElementById(`extraPerson-${k}`).value);
      });

      try {
        const res = await fetch('/api/inventory', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(inventory)
        });
        if (!res.ok) throw new Error('Save failed');
        alert('✅ Inventory updated successfully!');
      } catch (err) {
        console.error('saveInventory error', err);
        alert('Failed to save inventory. See console.');
      }
    }

    // ---------- Chart (single-day occupancy %) ----------
    async function loadChart() {
      const date = dateSelect.value;
      if (!date) return alert('Please select a date first.');

      try {
        // fetch bookings (we can ask the API for that single day range)
        const startISO = date;
        // end is exclusive next day
        const endISO = isoDate(addDays(parseYMD(date), 1));
        const bookings = await fetchBookingsRange(startISO, endISO);

        const counts = {};
        Object.keys(inventory).forEach(k => counts[k] = 0);
        const active = new Set(['approved','confirmed','checked_in']);
        bookings.forEach(b => {
          const st = String(b.status || '').toLowerCase();
          if (!active.has(st)) return;
          if (!counts[b.room]) counts[b.room] = 0;
          counts[b.room] += 1;
        });

        const labels = Object.keys(inventory).map(k => inventory[k].label);
        const data = Object.keys(inventory).map(k => {
          const total = inventory[k].qty || 1;
          return Math.round((counts[k] || 0) / total * 100);
        });

        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(chartCanvas, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Occupancy (%)',
              data,
              backgroundColor: 'rgba(14, 165, 233, 0.6)',
              borderColor: 'rgba(14, 165, 233, 1)',
              borderWidth: 1,
            }]
          },
          options: {
            scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Percent Occupied' } } },
            plugins: { legend: { display: false } }
          }
        });
      } catch (err) {
        console.error('Chart error:', err);
        alert('Failed to load chart.');
      }
    }

    // ===== Monthly Availability Editor =====
    function daysInMonth(year, month) { return new Date(year, month, 0).getDate(); }
    function dateString(y, m, d) { const mm = String(m).padStart(2,'0'); const dd = String(d).padStart(2,'0'); return `${y}-${mm}-${dd}`; }
    async function loadOverrides(start, end) {
      try { const res = await fetch(`/api/availability-overrides?start=${start}&end=${end}`); if (!res.ok) throw new Error('Failed to load overrides'); return await res.json(); }
      catch (e) { console.warn('Overrides load failed', e); return []; }
    }
    function mapOverrides(list) {
      const m = {};
      for (const it of list) {
        m[`${it.room}|${it.date}`] = {
          available: Number(it.available) || 0,
          rateNonAC: Number(it.rateNonAC ?? NaN),
          rateAC: Number(it.rateAC ?? NaN)
        };
      }
      return m;
    }
    function bookedCountsForDate(bookings, date, inventoryLocal) {
      const counts = {}; Object.keys(inventoryLocal).forEach(k => counts[k] = 0);
      bookings.forEach(b => {
        const st = String(b.status || '').toLowerCase();
        if (st === 'cancelled') return; // count all non-cancelled bookings, including payment_pending
        const ci = parseYMD(b.checkin); const co = parseYMD(b.checkout); const dd = parseYMD(date);
        if (dd >= ci && dd < co) { counts[b.room] = (counts[b.room]||0) + 1; }
      });
      return counts;
    }
    function buildMonthGrid(inventoryLocal, bookings, overridesMap, year, month) {
      const container = document.getElementById('monthGrid'); if (!container) return; const dcount = daysInMonth(year, month);
      const rooms = Object.keys(inventoryLocal).map(k => ({ key: k, label: inventoryLocal[k].label, qty: Number(inventoryLocal[k].qty)||0 }));
      let html = '<div class="overflow-x-auto"><table class="min-w-full border-collapse"><thead><tr><th class="px-2 py-1 text-left border">Room Type</th>';
      for (let d=1; d<=dcount; d++) html += `<th class="px-1 py-1 border text-xs">${d}</th>`; html += '</tr></thead><tbody>';
      for (const room of rooms) { html += `<tr><td class="px-2 py-1 border text-sm font-medium">${room.label}</td>`;
        for (let d=1; d<=dcount; d++) {
          const date = dateString(year, month, d);
          const booked = bookedCountsForDate(bookings, date, inventoryLocal)[room.key] || 0;
          // Treat override.available as the cap BEFORE bookings; then subtract bookings
          const key = `${room.key}|${date}`;
          const ov = overridesMap[key] || {};
          const baseCap = (ov.available !== undefined)
            ? Math.min(Math.max(0, Number(ov.available)), room.qty)
            : room.qty;
          const availVal = Math.max(0, baseCap - booked);
          const rateN = isNaN(ov.rateNonAC) ? (Number(inventoryLocal[room.key].rateNonAC)||0) : Number(ov.rateNonAC);
          const rateA = isNaN(ov.rateAC) ? (Number(inventoryLocal[room.key].rateAC)||0) : Number(ov.rateAC);
          const bg = (availVal>0) ? '#dcfce7' : '#fee2e2';
          html += `<td class="border px-1 py-1 text-left monthCell" data-room="${room.key}" data-date="${date}" style="background:${bg}">`
            + `<div class=\"text-[11px] text-gray-700\"><span class=\"font-medium\">Total Rooms:</span> ${room.qty}</div>`
            + `<div class=\"text-[11px] text-gray-700\"><span class=\"font-medium\">Rate Non-AC:</span> <input type=\"number\" class=\"rateNonACInput border rounded px-1 py-0.5 text-xs w-20 ml-1\" placeholder=\"Non-AC\" value=\"${rateN}\" /></div>`
            + `<div class=\"text-[11px] text-gray-700\"><span class=\"font-medium\">Rate AC:</span> <input type=\"number\" class=\"rateACInput border rounded px-1 py-0.5 text-xs w-20 ml-1\" placeholder=\"AC\" value=\"${rateA}\" /></div>`
            + `<div class=\"text-[11px] text-gray-700\"><span class=\"font-medium\">No. Booked:</span> ${booked}</div>`
            + `<div class=\"text-[11px] text-gray-900\"><span class=\"font-medium\">No. Available:</span> ${availVal}</div>`
            + `<div class=\"text-[10px] text-gray-600 mt-1\"><span class=\"font-medium\">Sellable (override cap):</span> <input type=\"number\" class=\"availInput border rounded px-1 py-0.5 text-xs w-20 ml-1\" data-room=\"${room.key}\" data-date=\"${date}\" min=\"0\" max=\"${room.qty}\" value=\"${baseCap}\" /></div>`
            + `</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table></div>'; container.innerHTML = html;
    }
    function renderSummary(inventoryLocal, bookings, overridesMap, dateISO) {
      const container = document.getElementById('monthSummary'); if (!container) return;
      const counts = bookedCountsForDate(bookings, dateISO, inventoryLocal);
      let html = '<div class="overflow-x-auto"><table class="min-w-full border-collapse"><thead><tr>'
        + '<th class="px-2 py-1 text-left border">Room Type</th>'
        + '<th class="px-2 py-1 text-left border">Total Rooms</th>'
        + '<th class="px-2 py-1 text-left border">Rate Non-AC (₹)</th>'
        + '<th class="px-2 py-1 text-left border">Rate AC (₹)</th>'
        + '<th class="px-2 py-1 text-left border">No. Booked</th>'
        + '<th class="px-2 py-1 text-left border">No. Available</th>'
        + '</tr></thead><tbody>';
      Object.keys(inventoryLocal).forEach(key => {
        const inv = inventoryLocal[key];
        const ov = (overridesMap[`${key}|${dateISO}`] || {});
        const baseCap = (ov.available !== undefined)
          ? Math.min(Math.max(0, Number(ov.available)), Number(inv.qty)||0)
          : Number(inv.qty)||0;
        const booked = counts[key] || 0;
        const available = Math.max(0, baseCap - booked);
        const rateN = isNaN(ov.rateNonAC) ? (Number(inv.rateNonAC)||0) : Number(ov.rateNonAC);
        const rateA = isNaN(ov.rateAC) ? (Number(inv.rateAC)||0) : Number(ov.rateAC);
        html += `<tr>`
          + `<td class="px-2 py-1 border">${inv.label}</td>`
          + `<td class="px-2 py-1 border">${inv.qty}</td>`
          + `<td class="px-2 py-1 border">${rateN}</td>`
          + `<td class="px-2 py-1 border">${rateA}</td>`
          + `<td class="px-2 py-1 border">${booked}</td>`
          + `<td class="px-2 py-1 border">${available}</td>`
          + `</tr>`;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    async function renderMonthEditor(inventoryLocal, bookings) {
      const picker = document.getElementById('monthPicker'); const now = new Date(); const defaultMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; if (!picker.value) picker.value = defaultMonth; const [yStr, mStr] = picker.value.split('-'); const year = Number(yStr); const month = Number(mStr); const dcount = daysInMonth(year, month); const start = `${picker.value}-01`; const end = dateString(year, month, dcount + 1); const overrides = await loadOverrides(start, end); const overridesMap = mapOverrides(overrides); buildMonthGrid(inventoryLocal, bookings, overridesMap, year, month);
      // Summary setup
      const summaryInput = document.getElementById('summaryDate');
      if (summaryInput) {
        // default to first day of selected month
        summaryInput.value = start;
        summaryInput.min = start;
        // end is exclusive; set max to last day of month
        const lastDayISO = dateString(year, month, dcount);
        summaryInput.max = lastDayISO;
        renderSummary(inventoryLocal, bookings, overridesMap, summaryInput.value);
        // Re-render summary on date change
        summaryInput.onchange = () => {
          const v = summaryInput.value;
          if (!v) return;
          renderSummary(inventoryLocal, bookings, overridesMap, v);
        };
      }
    }
    async function saveOverrides() {
      const cells = Array.from(document.querySelectorAll('.monthCell'));
      const payload = cells.map(cell => ({
        room: cell.dataset.room,
        date: cell.dataset.date,
        available: Number(cell.querySelector('.availInput')?.value) || 0,
        rateNonAC: Number(cell.querySelector('.rateNonACInput')?.value) || 0,
        rateAC: Number(cell.querySelector('.rateACInput')?.value) || 0
      }));
      try {
        const res = await fetch('/api/availability-overrides', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ overrides: payload })
        });
        if (!res.ok) throw new Error('Save failed');
        const j = await res.json();
        alert(`Saved ${j.updated || 0} cells`);
      } catch (e) {
        console.error('saveOverrides error', e);
        alert('Failed to save changes.');
      }
    }

    // ---------- Calendar logic & rendering ----------
    const msDay = 24 * 60 * 60 * 1000;
    function computeCounts(bookings, dates, inventoryLocal) {
      // initialize
      const counts = {};
      Object.keys(inventoryLocal).forEach(k => {
        counts[k] = {};
        dates.forEach(d => counts[k][d] = 0);
      });

      const active = new Set(['approved','confirmed','checked_in']);
      bookings.forEach(b => {
        const st = String(b.status || '').toLowerCase();
        if (!active.has(st)) return;
        const ci = parseYMD(b.checkin);
        const co = parseYMD(b.checkout);
        dates.forEach(d => {
          const dd = parseYMD(d);
          if (dd >= ci && dd < co) {
            if (counts[b.room] && typeof counts[b.room][d] === 'number') {
              counts[b.room][d] += 1;
            }
          }
        });
      });
      return counts;
    }

    function renderCalendar(dates, inventoryLocal, counts, bookingsCache) {
      // Clear
      calendarGrid.innerHTML = '';

      // Build grid column template: first label col then one col per day
      const colTemplate = [`180px`, ...dates.map(() => `100px`) ].join(' ');
      calendarGrid.style.display = 'grid';
      calendarGrid.style.gridTemplateColumns = colTemplate;

      // Header row: empty + dates
      const headerLabel = document.createElement('div');
      headerLabel.className = 'p-2 font-semibold text-sm';
      headerLabel.textContent = '';
      calendarGrid.appendChild(headerLabel);

      dates.forEach(d => {
        const h = document.createElement('div');
        h.className = 'p-2 text-center text-sm font-semibold border-b';
        const dt = parseYMD(d);
        const dayShort = dt.toLocaleDateString(undefined, { weekday: 'short' });
        const md = dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        h.innerHTML = `<div class="text-xs text-gray-500">${dayShort}</div><div>${md}</div>`;
        calendarGrid.appendChild(h);
      });

      // Rows
      Object.keys(inventoryLocal).forEach(k => {
        // label cell
        const labelCell = document.createElement('div');
        labelCell.className = 'p-2 border-r font-medium';
        labelCell.innerHTML = `<div>${inventoryLocal[k].label}</div><div class="text-xs text-gray-500">Qty: ${inventoryLocal[k].qty}</div>`;
        calendarGrid.appendChild(labelCell);

        // day cells
        dates.forEach(d => {
          const used = counts[k][d] || 0;
          const available = Math.max(0, (inventoryLocal[k].qty || 0) - used);
          const cell = document.createElement('div');
          cell.className = 'p-2 text-center text-sm align-middle border cursor-pointer select-none';
          cell.setAttribute('data-room', k);
          cell.setAttribute('data-date', d);
          cell.setAttribute('data-used', used);
          cell.setAttribute('data-available', available);

          // color thresholds: 0 -> red, <=1 -> amber, else green
          if (available === 0) {
            cell.style.backgroundColor = '#ef4444';
            cell.style.color = 'white';
          } else if (available <= 1) {
            cell.style.backgroundColor = '#f59e0b';
            cell.style.color = 'white';
          } else {
            cell.style.backgroundColor = '#10b981';
            cell.style.color = 'white';
          }

          cell.innerHTML = `<div class="text-sm font-semibold">${available}</div><div class="text-xs">${used}/${inventoryLocal[k].qty}</div>`;
          cell.title = `${inventoryLocal[k].label} — ${d}\nUsed: ${used}\nAvailable: ${available}`;

          // click shows booking details for that day+room in a simple dialog
          cell.addEventListener('click', () => {
            const list = bookingsCache.filter(b => {
              return b.room === k && (parseYMD(d) >= parseYMD(b.checkin)) && (parseYMD(d) < parseYMD(b.checkout)) && b.status !== 'cancelled';
            });
            let msg = `${inventoryLocal[k].label} — ${d}\nUsed: ${used}\nAvailable: ${available}\n\nBookings:\n`;
            if (list.length === 0) msg += 'No bookings';
            else msg += list.map(x => `${x.id} | ${x.name || '-'} | ${x.checkin}→${x.checkout} | ₹${x.total || 0}`).join('\n');
            // use window.open to show nicer view if there are images
            const w = window.open('', '_blank', 'width=600,height=400');
            if (w) {
              w.document.title = `Bookings ${inventoryLocal[k].label} ${d}`;
              w.document.body.style.fontFamily = 'system-ui, Arial, sans-serif';
              w.document.body.innerHTML = `<pre style="white-space:pre-wrap">${msg}</pre>`;
            } else {
              alert(msg);
            }
          });

          calendarGrid.appendChild(cell);
        });
      });
    }

    // ---------- Orchestration for calendar ----------
    let startDate = new Date(); // local today
    async function loadAndRenderCalendar() {
      const days = parseInt(rangeSelect.value, 10) || 14;
      const dates = generateDates(startDate, days);
      const startISO = dates[0];
      const lastPlus1 = isoDate(addDays(parseYMD(dates[dates.length - 1]), 1));
      const endISO = lastPlus1;
      // fetch bookings overlapping [startISO, endISO)
      const bookings = await fetchBookingsRange(startISO, endISO);
      const counts = computeCounts(bookings, dates, inventory);
      renderCalendar(dates, inventory, counts, bookings);
      // scroll to start
      calendarWrap.scrollLeft = 0;
    }

    // Controls
    rangeSelect.addEventListener('change', () => loadAndRenderCalendar());
    prevBtn.addEventListener('click', () => { startDate = addDays(startDate, -parseInt(rangeSelect.value,10)); loadAndRenderCalendar(); });
    nextBtn.addEventListener('click', () => { startDate = addDays(startDate, parseInt(rangeSelect.value,10)); loadAndRenderCalendar(); });
    reloadCalendarBtn.addEventListener('click', () => loadAndRenderCalendar());

    // ---------- Initial load and bindings ----------
    saveBtn.addEventListener('click', saveInventory);
    refreshBtn.addEventListener('click', loadInventory);
    if (loadChartBtn && chartCanvas) { loadChartBtn.addEventListener('click', loadChart); }
    
    // Room modal events
     addRoomBtn.addEventListener('click', () => {
       modalTitle.textContent = 'Add Room';
       roomForm.reset();
       editModeInput.value = 'false';
       roomIdInput.disabled = false;
       roomModal.classList.remove('hidden');
     });
     
     closeModal.addEventListener('click', () => roomModal.classList.add('hidden'));
     cancelBtn.addEventListener('click', () => roomModal.classList.add('hidden'));
     
     // Edit room button event delegation
     inventoryTable.addEventListener('click', (e) => {
       if (e.target.classList.contains('edit-room-btn')) {
         const roomId = e.target.dataset.room;
         openEditModal(roomId);
       } else if (e.target.classList.contains('delete-room-btn')) {
         const roomId = e.target.dataset.room;
         deleteRoom(roomId);
       }
     });
     
     // Open edit modal
     function openEditModal(roomId) {
       const room = inventory[roomId];
       if (!room) return;
       
       modalTitle.textContent = 'Edit Room';
       editModeInput.value = 'true';
       roomIdInput.value = roomId;
       roomIdInput.disabled = true;
       document.getElementById('roomLabel').value = room.label;
       document.getElementById('roomQty').value = room.qty;
       document.getElementById('rateNonAC').value = room.rateNonAC;
       document.getElementById('rateAC').value = room.rateAC;
       
       roomModal.classList.remove('hidden');
     }
     
     // Delete room
     async function deleteRoom(roomId) {
       if (!confirm(`Are you sure you want to delete room "${inventory[roomId].label}"?`)) return;
       
       try {
         const response = await fetch(`/api/inventory-crud?room=${roomId}`, {
           method: 'DELETE'
         });
         
         if (!response.ok) {
           const error = await response.json();
           throw new Error(error.error || 'Failed to delete room');
         }
         
         await loadData();
         alert('Room deleted successfully');
       } catch (error) {
         console.error('Error deleting room:', error);
         alert(error.message);
       }
     }
     
     // Save room form
     roomForm.addEventListener('submit', async (e) => {
       e.preventDefault();
       
       try {
         const isEdit = editModeInput.value === 'true';
         const roomData = {
           room: document.getElementById('roomId').value,
           label: document.getElementById('roomLabel').value,
           qty: parseInt(document.getElementById('roomQty').value),
           rateNonAC: parseFloat(document.getElementById('rateNonAC').value) || 0,
           rateAC: parseFloat(document.getElementById('rateAC').value) || 0
         };
         
         const method = isEdit ? 'PUT' : 'POST';
         const response = await fetch('/api/inventory-crud', {
           method,
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(roomData)
         });
         
         if (!response.ok) {
           const ct = (response.headers.get('content-type') || '').toLowerCase();
           if (ct.includes('application/json')) {
             const error = await response.json();
             throw new Error(error.error || 'Failed to save room');
           } else {
             const text = await response.text();
             throw new Error(text || 'Failed to save room');
           }
         }
         
         roomModal.classList.add('hidden');
         await loadData();
         alert(isEdit ? 'Room updated successfully' : 'Room added successfully');
       } catch (error) {
         console.error('Error saving room:', error);
         alert(error.message);
       }
     });

    // Render inventory table rows from current inventory
    function renderInventoryTable() {
      const tbody = inventoryTable;
      tbody.innerHTML = '';
      const keys = Object.keys(inventory);
      if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No rooms found.</td></tr>';
        return;
      }
      keys.forEach((key) => {
        const r = inventory[key];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${key}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.label}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.qty}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹${r.rateNonAC}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹${r.rateAC}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button class="edit-room-btn text-indigo-600 hover:text-indigo-900" data-room="${key}">Edit</button>
            <button class="delete-room-btn text-red-600 hover:text-red-800 ml-3" data-room="${key}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Unified refresh helper: reload data and refresh UI sections
    async function loadData() {
      inventory = await fetchInventoryAPI();
      renderInventory();
      if (inventoryTable) renderInventoryTable();
      if (calendarGrid) await loadAndRenderCalendar();
    }

    // load inventory then calendar
    await loadInventory();
    // set dateSelect default to today
    dateSelect.value = isoDate(new Date());
    // initial chart (auto render)
    if (chartCanvas) { await loadChart(); }
    // initial calendar
    if (calendarGrid) { await loadAndRenderCalendar(); }

    // Initial render for monthly editor
    try {
      const now = new Date();
      const startISO = isoDate(new Date(now.getFullYear(), now.getMonth(), 1));
      const endISO = isoDate(new Date(now.getFullYear(), now.getMonth()+1, 1));
      const bookingsMonth = await fetchBookingsRange(startISO, endISO);
      await renderMonthEditor(inventory, bookingsMonth);
    } catch (e) {
      console.warn('Initial month editor render failed', e);
    }

    // Hide old chart controls since chart was replaced
    document.getElementById('loadChartBtn')?.closest('div')?.classList.add('hidden');
    document.getElementById('dateSelect')?.closest('div')?.classList.add('hidden');
    document.getElementById('chartRange')?.closest('div')?.classList.add('hidden');

    // Wire month editor buttons
    document.getElementById('loadMonthBtn')?.addEventListener('click', async () => {
      try {
        const picker = document.getElementById('monthPicker');
        const [yStr, mStr] = picker.value.split('-');
        const year = Number(yStr); const month = Number(mStr);
        const startISO = isoDate(new Date(year, month - 1, 1));
        const endISO = isoDate(new Date(year, month, 1));
        const bookings = await fetchBookingsRange(startISO, endISO);
        await renderMonthEditor(inventory, bookings);
      } catch (e) {
        console.error('Load month failed', e);
        alert('Failed to load month data');
      }
    });
    document.getElementById('saveOverridesBtn')?.addEventListener('click', saveOverrides);

  })();
  </script>

</Layout>
