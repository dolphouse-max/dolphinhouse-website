---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminHeader from '../../components/AdminHeader.astro';
import { isAuthenticated } from '../../middleware/auth.js';

// Check if user is authenticated
const authenticated = await isAuthenticated(Astro);
if (!authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Admin ‚Äì Bookings">
  <AdminHeader />

  <section class="max-w-7xl mx-auto p-6 space-y-8">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Admin ‚Äì Bookings</h1>
      <div class="flex gap-3">
        <button id="addBookingBtn" class="px-4 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 transition">‚ûï New Booking</button>
        <button id="refreshBtn" class="px-4 py-2 bg-sky-600 text-white rounded shadow hover:bg-sky-700 transition">üîÑ Refresh</button>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button class="filter-tab" data-status="all">All Bookings</button>
      <button class="filter-tab active" data-status="pending">‚è≥ Pending Approval (<span id="pendingCount">0</span>)</button>
      <button class="filter-tab" data-status="approved">‚úÖ Approved</button>
      <button class="filter-tab" data-status="confirmed">üíö Confirmed</button>
      <button class="filter-tab" data-status="payment_submitted">üí≥ Payment Submitted</button>
      <button class="filter-tab" data-status="checked_in">üè® Checked In</button>
      <button class="filter-tab" data-status="cancelled">‚ùå Cancelled</button>
    </div>

    <!-- Filter + Summary -->
    <div class="flex flex-wrap items-end gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Select Date</label><br/>
        <input id="filterDate" type="date" class="border px-3 py-2 rounded">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Status</label><br/>
        <select id="statusFilter" class="border px-3 py-2 rounded">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="payment_pending">Payment Pending</option>
          <option value="approved">Approved</option>
          <option value="confirmed">Confirmed</option>
          <option value="payment_submitted">Payment Submitted</option>
          <option value="checked_in">Checked In</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Room Type</label><br/>
        <select id="roomFilter" class="border px-3 py-2 rounded">
          <option value="">All Rooms</option>
        </select>
      </div>
      <div id="summary" class="text-gray-800 font-medium">
        Total: <span id="totalBookings">0</span> bookings
      </div>
    </div>

    <!-- Occupancy Chart -->
    <div class="bg-white p-6 rounded-lg shadow border">
      <h2 class="text-xl font-semibold mb-4">üìä Daily Occupancy</h2>
      <canvas id="occupancyChart" height="120"></canvas>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto bg-white rounded-lg shadow border">
      <table class="w-full text-sm border-collapse">
        <thead class="bg-gray-100 border-b text-left text-gray-700">
          <tr>
            <th class="px-4 py-2">ID</th>             
            <th class="px-4 py-2">Customer ID</th>
            <th class="px-4 py-2">Guest</th>
            <th class="px-4 py-2">Mobile</th>
            <th class="px-4 py-2">Room</th>
            <th class="px-4 py-2">Dates</th>
            <th class="px-4 py-2">Nights</th>         
            <th class="px-4 py-2">Guests</th>
            <th class="px-4 py-2">Total</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="bookingTable"></tbody>
      </table>
    </div>
  </section>

  <!-- Booking Add/Edit Modal -->
  <div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 id="modalTitle" class="text-xl font-bold">Add New Booking</h2>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      
      <form id="bookingForm" class="space-y-4">
        <input type="hidden" id="bookingId" value="">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Guest Name</label>
            <input type="text" id="guestName" class="mt-1 block w-full border rounded-md px-3 py-2" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="guestEmail" class="mt-1 block w-full border rounded-md px-3 py-2" placeholder="Optional">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Mobile</label>
            <input type="tel" id="guestMobile" class="mt-1 block w-full border rounded-md px-3 py-2" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Customer ID</label>
            <input type="text" id="customerId" class="mt-1 block w-full border rounded-md px-3 py-2" placeholder="Auto-generated">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Room Type</label>
            <select id="roomType" class="mt-1 block w-full border rounded-md px-3 py-2" required>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Number of Guests</label>
            <input type="number" id="guestCount" min="1" class="mt-1 block w-full border rounded-md px-3 py-2" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Check-in Date</label>
            <input type="date" id="checkinDate" class="mt-1 block w-full border rounded-md px-3 py-2" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Check-out Date</label>
            <input type="date" id="checkoutDate" class="mt-1 block w-full border rounded-md px-3 py-2" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Total Amount (‚Çπ)</label>
            <input type="number" id="totalAmount" min="0" step="0.01" class="mt-1 block w-full border rounded-md px-3 py-2" required>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Booking From</label>
            <select id="bookingFrom" class="mt-1 block w-full border rounded-md px-3 py-2" required>
              <option value="Direct">Direct</option>
              <option value="Makemytrip">Makemytrip</option>
              <option value="Goibibo">Goibibo</option>
              <option value="booking.com">booking.com</option>
              <option value="Airbnb">Airbnb</option>
              <option value="others">others</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Status</label>
            <select id="bookingStatus" class="mt-1 block w-full border rounded-md px-3 py-2" required>
              <option value="pending">Pending</option>
              <option value="payment_pending">Payment Pending</option>
              <option value="approved">Approved</option>
              <option value="confirmed">Confirmed</option>
              <option value="payment_submitted">Payment Submitted</option>
              <option value="checked_in">Checked In</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancelBtn" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100">Cancel</button>
          <button type="submit" id="saveBookingBtn" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Save Booking</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Approval Modal -->
  <div id="approvalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">‚úÖ Approve Booking</h2>
        <button id="closeApprovalModal" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div id="approvalContent" class="space-y-4">
        <!-- Booking details will be loaded here -->
      </div>

      <div class="flex gap-3 mt-6">
        <button id="confirmApprovalBtn" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
          ‚úÖ Approve & Send Confirmation Email
        </button>
        <button id="cancelApprovalBtn" class="px-6 py-3 border rounded-lg hover:bg-gray-100 transition">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Check-in Details Modal -->
  <div id="checkinModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 my-8 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">üè® Check-in Details</h2>
        <button id="closeCheckinModal" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="checkinContent" class="space-y-4">
        <!-- Check-in details will be loaded here -->
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let bookings = [];
    let inventory = {};
    let chartInstance = null;
    let editMode = false;
    let currentBookingForApproval = null;
    let currentStatusFilter = 'pending';
    
    // Setup logout functionality
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/admin-auth', {
          method: 'DELETE'
        });
        
        if (response.ok) {
          window.location.href = '/admin/login';
        }
      } catch (error) {
        console.error('Logout error:', error);
      }
    });
    
    // Calculate nights between two dates
    function calculateNights(checkin, checkout) {
      const start = new Date(checkin);
      const end = new Date(checkout);
      const diffTime = Math.abs(end - start);
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // Send payment notification via Vilpower templates
    async function sendPaymentNotification(bookingId, type) {
      try {
        const res = await fetch('/api/notify-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ booking_id: bookingId, type })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          alert(type === 'received' ? 'Payment Received SMS sent.' : 'Payment Pending SMS sent.');
        } else {
          alert('Failed to send SMS: ' + (data.error || res.statusText));
        }
      } catch (err) {
        console.error('notify-payment error:', err);
        alert('Error sending SMS: ' + err.message);
      }
    }

    // Send manual review invite SMS
    async function sendReviewInvite(bookingId) {
      try {
        const res = await fetch('/api/review-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ booking_id: bookingId })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          alert('Review invite SMS sent.');
        } else {
          alert('Failed to send review SMS: ' + (data.error || res.statusText));
        }
      } catch (err) {
        console.error('review-invite error:', err);
        alert('Error sending review SMS: ' + err.message);
      }
    }

    const table = document.getElementById('bookingTable');
    const dateInput = document.getElementById('filterDate');
    const statusFilter = document.getElementById('statusFilter');
    const roomFilter = document.getElementById('roomFilter');
    const summary = document.getElementById('summary');
    const refreshBtn = document.getElementById('refreshBtn');
    const chartCanvas = document.getElementById('occupancyChart');
    const totalBookingsSpan = document.getElementById('totalBookings');
    
    // Modal elements
    const bookingModal = document.getElementById('bookingModal');
    const modalTitle = document.getElementById('modalTitle');
    const bookingForm = document.getElementById('bookingForm');
    const addBookingBtn = document.getElementById('addBookingBtn');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');

    // Approval modal elements
    const approvalModal = document.getElementById('approvalModal');
    const approvalContent = document.getElementById('approvalContent');
    const closeApprovalModal = document.getElementById('closeApprovalModal');
    const cancelApprovalBtn = document.getElementById('cancelApprovalBtn');
    const confirmApprovalBtn = document.getElementById('confirmApprovalBtn');

    // Check-in modal elements
    const checkinModal = document.getElementById('checkinModal');
    const checkinContent = document.getElementById('checkinContent');
    const closeCheckinModal = document.getElementById('closeCheckinModal');

    // Filter tabs
    const filterTabs = document.querySelectorAll('.filter-tab');

    // Normalize status string to a consistent format
    function normStatus(s) {
      return String(s || '')
        .toLowerCase()
        .trim()
        .replace(/[-\s]+/g, '_');
    }

    function statusBadge(status) {
      const map = {
        pending: "bg-yellow-100 text-yellow-800 border-yellow-300",
        payment_pending: "bg-yellow-100 text-yellow-800 border-yellow-300",
        approved: "bg-green-100 text-green-800 border-green-300",
        confirmed: "bg-blue-100 text-blue-800 border-blue-300",
        payment_submitted: "bg-yellow-100 text-yellow-800 border-yellow-300",
        checked_in: "bg-indigo-100 text-indigo-800 border-indigo-300",
        cancelled: "bg-red-100 text-red-800 border-red-300"
      };
      const cls = map[status?.toLowerCase()] || "bg-gray-100 text-gray-700 border-gray-300";
      return `<span class="px-2 py-1 text-xs rounded border ${cls} capitalize">${(status || 'unknown').replace('_',' ')}</span>`;
    }

    async function loadData() {
      try {
        const [bRes, iRes] = await Promise.allSettled([
          fetch('/api/bookings'),
          fetch('/api/inventory')
        ]);

        // bookings
        if (bRes.status === 'fulfilled' && bRes.value.ok) {
          bookings = await bRes.value.json();
        } else {
          console.warn('bookings API failed ‚Äì using sample data');
          const today = new Date();
          const iso = (d) => new Date(d).toISOString().slice(0,10);
          const addDays = (d,n)=>{const dt=new Date(d); dt.setDate(dt.getDate()+n); return dt;};
          bookings = [
            { id: 'local-1', customer_id: 'dh00000001', name: 'Amit Sharma', email: 'amit@example.com', mobile: '9812345678', room: 'standard', checkin: iso(today), checkout: iso(addDays(today,2)), nights: 2, guests: 2, total: 5000, status: 'pending', createdAt: new Date().toISOString() },
            { id: 'local-2', customer_id: 'dh00000002', name: 'Neha Desai', email: 'neha@example.com', mobile: '9876543210', room: 'deluxe', checkin: iso(addDays(today,1)), checkout: iso(addDays(today,3)), nights: 2, guests: 3, total: 7000, status: 'approved', createdAt: new Date().toISOString() }
          ];
        }

        // inventory
        let invPayload = {};
        if (iRes.status === 'fulfilled' && iRes.value.ok) {
          const j = await iRes.value.json();
          if (Array.isArray(j)) {
            j.forEach(it => { if (it?.room) invPayload[it.room] = it; });
          } else if (j && typeof j === 'object') {
            invPayload = j;
          }
        } else {
          console.warn('inventory API failed ‚Äì using defaults');
          invPayload = {
            standard: { label: 'Standard Room', qty: 5, rateNonAC: 2000, rateAC: 2500 },
            deluxe: { label: 'Deluxe Room', qty: 3, rateNonAC: 3000, rateAC: 3500 },
            family: { label: 'Family Room', qty: 1, rateNonAC: 3500, rateAC: 4000 },
            deluxeFamily: { label: 'Deluxe Family Room', qty: 1, rateNonAC: 4500, rateAC: 5000 }
          };
        }

        inventory = invPayload;
        
        // Populate room filter dropdown
        populateRoomFilter();
        
        // Update pending count
        updatePendingCount();
        
        // Update total bookings
        totalBookingsSpan.textContent = bookings.length;
        
        // Apply any active filters
        applyFilters();
        renderChart();
      } catch (error) {
        console.error('Error loading data:', error);
        alert('Failed to load data from APIs; showing sample data.');
        // As a last resort, ensure basic defaults are present
        inventory = inventory && Object.keys(inventory).length ? inventory : {
          standard: { label: 'Standard Room', qty: 5, rateNonAC: 2000, rateAC: 2500 },
          deluxe: { label: 'Deluxe Room', qty: 3, rateNonAC: 3000, rateAC: 3500 }
        };
        bookings = Array.isArray(bookings) ? bookings : [];
        populateRoomFilter();
        updatePendingCount();
        totalBookingsSpan.textContent = bookings.length;
        applyFilters();
        renderChart();
      }
    }
    
    function updatePendingCount() {
      const pendingCount = bookings.filter(b => {
        const st = normStatus(b.status);
        return st === 'pending' || st === 'payment_pending' || st === 'payment_submitted';
      }).length;
      document.getElementById('pendingCount').textContent = pendingCount;
    }
    
    function populateRoomFilter() {
      // Clear existing options except the first one
      while (roomFilter.options.length > 1) {
        roomFilter.remove(1);
      }
      
      // Add room options from inventory
      Object.keys(inventory).forEach(room => {
        const option = document.createElement('option');
        option.value = room;
        option.textContent = inventory[room].label || room;
        roomFilter.appendChild(option);
      });
      
      // Also populate room options in the booking form
      const roomTypeSelect = document.getElementById('roomType');
      roomTypeSelect.innerHTML = '';
      Object.keys(inventory).forEach(room => {
        const label = inventory[room].label || room;
        const optNonAC = document.createElement('option');
        optNonAC.value = `${room}|nonac`;
        optNonAC.textContent = `${label} Non ac`;
        roomTypeSelect.appendChild(optNonAC);

        const optAC = document.createElement('option');
        optAC.value = `${room}|ac`;
        optAC.textContent = `${label} ac`;
        roomTypeSelect.appendChild(optAC);
      });
    }
    
    function applyFilters() {
      const filterDate = dateInput.value;
      const statusValue = statusFilter.value;
      const roomValue = roomFilter.value;
      
      let filtered = bookings;
      
      // Apply status tab filter (treat payment_pending/payment_submitted as pending for filter tabs)
      if (currentStatusFilter !== 'all') {
        filtered = filtered.filter(b => {
          const st = normStatus(b.status);
          const cur = normStatus(currentStatusFilter);
          if (cur === 'pending') {
            return st === 'pending' || st === 'payment_pending' || st === 'payment_submitted';
          }
          return st === cur;
        });
      }
      
      // Apply date filter if selected
      if (filterDate) {
        const sel = new Date(filterDate);
        filtered = filtered.filter(b => {
          const ci = new Date(b.checkin);
          const co = new Date(b.checkout);
          return sel >= ci && sel < co && b.status !== 'cancelled';
        });
      }
      
      // Apply status filter if selected
      if (statusValue) {
        const sv = normStatus(statusValue);
        if (sv === 'pending') {
          // Treat dropdown "Pending" as including payment_pending and payment_submitted
          filtered = filtered.filter(b => {
            const st = normStatus(b.status);
            return st === 'pending' || st === 'payment_pending' || st === 'payment_submitted';
          });
        } else {
          filtered = filtered.filter(b => normStatus(b.status) === sv);
        }
      }
      
      // Apply room filter if selected
      if (roomValue) {
        filtered = filtered.filter(b => b.room === roomValue);
      }
      
      renderTable(filtered);
      
      if (filterDate) updateSummary(filterDate, filtered);
    }
    
    function updateSummary(date, bookings) {
      const count = bookings.length;
      summary.innerHTML = `üìÖ ${count} booking(s) for ${new Date(date).toLocaleDateString()}`;
    }

    function renderTable(filtered) {
      table.innerHTML = '';
      
      if (!filtered || filtered.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `<td colspan="11" class="px-4 py-4 text-center text-gray-500">No bookings found matching your criteria</td>`;
        table.appendChild(emptyRow);
        return;
      }
      
      filtered.forEach(b => { 
        const tr = document.createElement('tr');
        tr.className = "border-b hover:bg-gray-50";
        
        // Determine action buttons based on status
        let actionButtons = '';
        
        if (['pending','payment_pending','payment_submitted'].includes(normStatus(b.status))) {
          actionButtons = `
            <button class="approve-btn px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 font-medium mr-1" data-id="${b.id}">
              ‚úÖ Approve
            </button>
          `;
        }
        
        if (normStatus(b.status) === 'checked_in') {
          actionButtons += `
            <button class="view-checkin-btn px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 font-medium mr-1" data-id="${b.id}">
              üëÅÔ∏è Check-in
            </button>
          `;
        }

        // Payment SMS actions (vilpower)
        if (b.mobile) {
          // Show Pending SMS only for pending/payment_pending statuses
          if (["pending", "payment_pending"].includes(normStatus(b.status))) {
            actionButtons += `
              <button class="sms-pending-btn px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200" data-id="${b.id}">
                üì® Pending SMS
              </button>
            `;
          }
          // Show Received SMS for approved/payment_submitted/confirmed statuses
          if (["approved", "payment_submitted", "confirmed"].includes(normStatus(b.status))) {
            actionButtons += `
              <button class="sms-received-btn px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200" data-id="${b.id}">
                ‚úÖ Received SMS
              </button>
            `;
          }
          // Manual Review Invite action (vilpower)
          actionButtons += `
            <button class="sms-review-btn px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200" data-id="${b.id}">
              ‚≠ê Review SMS
            </button>
          `;
        }
        
        tr.innerHTML = ` 
          <td class="px-4 py-2 font-mono text-xs text-gray-500">${b.id.substring(0, 8)}...</td>
          <td class="px-4 py-2 font-mono text-xs text-sky-600">${b.customer_id || 'N/A'}</td>
          <td class="px-4 py-2">
            <div class="font-medium">${b.name || '(no name)'}</div>
            <div class="text-xs text-gray-500">${b.email || '(no email)'}</div>
          </td>
          <td class="px-4 py-2">
            ${b.mobile ? `<a href="tel:${b.mobile}" class="text-sky-600 hover:underline">${b.mobile}</a>` : 'N/A'}
          </td>
          <td class="px-4 py-2">
            <div class="capitalize">${inventory[b.room]?.label || b.room}</div>
            <div class="text-xs text-gray-500">Rooms: ${Number(b.rooms || 1)}</div>
          </td>
          <td class="px-4 py-2">
            <div class="text-sm">${b.checkin}</div>
            <div class="text-xs text-gray-500">‚Üí ${b.checkout}</div>
          </td>
          <td class="px-4 py-2 text-center">${b.nights}</td>
          <td class="px-4 py-2 text-center">${b.guests}</td>
          <td class="px-4 py-2 font-semibold">‚Çπ${b.total?.toLocaleString() || 'N/A'}</td>
          <td class="px-4 py-2">${statusBadge(b.status)}</td>
          <td class="px-4 py-2">
            <div class="flex flex-wrap gap-1">
              ${actionButtons}
              <button class="edit-btn px-2 py-1 text-xs bg-sky-100 text-sky-700 rounded hover:bg-sky-200" data-id="${b.id}">Edit</button>
              <a href="/admin/invoice/${b.id}" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Invoice</a>
              <button class="delete-btn px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" data-id="${b.id}">Delete</button>
            </div>
          </td>
        `;
        table.appendChild(tr);
        
        // Add event listeners to the buttons
        const editBtn = tr.querySelector('.edit-btn');
        const deleteBtn = tr.querySelector('.delete-btn');
        const viewCheckinBtn = tr.querySelector('.view-checkin-btn');
        const approveBtn = tr.querySelector('.approve-btn');
        const smsPendingBtn = tr.querySelector('.sms-pending-btn');
        const smsReceivedBtn = tr.querySelector('.sms-received-btn');
        const smsReviewBtn = tr.querySelector('.sms-review-btn');
        
        editBtn.addEventListener('click', () => openEditModal(b.id));
        deleteBtn.addEventListener('click', () => deleteBooking(b.id));
        
        if (approveBtn) {
          approveBtn.addEventListener('click', () => openApprovalModal(b.id));
        }
        
        if (viewCheckinBtn) {
          viewCheckinBtn.addEventListener('click', () => viewCheckinDetails(b.id));
        }

        if (smsPendingBtn) {
          smsPendingBtn.addEventListener('click', () => sendPaymentNotification(b.id, 'pending'));
        }
        if (smsReceivedBtn) {
          smsReceivedBtn.addEventListener('click', () => sendPaymentNotification(b.id, 'received'));
        }
        if (smsReviewBtn) {
          smsReviewBtn.addEventListener('click', () => {
            const name = b.name || 'guest';
            const ok = confirm(`Send review invite to ${name}?`);
            if (ok) sendReviewInvite(b.id);
          });
        }
      });
    }
    
    function renderChart() {
      if (chartInstance) {
        chartInstance.destroy();
      }
      
      const ctx = chartCanvas.getContext('2d');
      const labels = Object.keys(inventory).map(room => inventory[room].label || room);
      const data = Object.keys(inventory).map(room => {
        const roomBookings = bookings.filter(b => b.room === room && b.status !== 'cancelled');
        return roomBookings.length;
      });
      
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Current Bookings',
            data: data,
            backgroundColor: 'rgba(14, 165, 233, 0.6)',
            borderColor: 'rgba(14, 165, 233, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
    
    // ====================
    // APPROVAL WORKFLOW
    // ====================
    
    function openApprovalModal(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;

      currentBookingForApproval = booking;
      
      approvalContent.innerHTML = `
        <div class="bg-sky-50 p-4 rounded-lg border border-sky-200">
          <h3 class="font-bold text-lg mb-3">Booking Details:</h3>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="font-medium">Booking ID:</span> ${booking.id.substring(0, 13)}...</div>
            <div><span class="font-medium">Customer ID:</span> ${booking.customer_id || 'Will be generated'}</div>
            <div><span class="font-medium">Guest Name:</span> ${booking.name || 'Not provided'}</div>
            <div><span class="font-medium">Mobile:</span> ${booking.mobile || 'Not provided'}</div>
            <div><span class="font-medium">Email:</span> ${booking.email || 'Not provided'}</div>
            <div><span class="font-medium">Room Type:</span> ${inventory[booking.room]?.label || booking.room}</div>
            <div><span class="font-medium">Check-in:</span> ${booking.checkin}</div>
            <div><span class="font-medium">Check-out:</span> ${booking.checkout}</div>
            <div><span class="font-medium">Nights:</span> ${booking.nights}</div>
            <div><span class="font-medium">Guests:</span> ${booking.guests}</div>
            <div class="col-span-2"><span class="font-medium">Total Amount:</span> <span class="text-lg font-bold text-green-700">‚Çπ${booking.total?.toLocaleString()}</span></div>
          </div>
        </div>

        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mt-4">
          <h4 class="font-bold mb-2">‚ö†Ô∏è Approval Actions:</h4>
          <ul class="text-sm space-y-1 list-disc list-inside">
            <li>Booking status will change to <strong>"Approved"</strong></li>
            <li>Confirmation email will be sent to customer ${booking.email ? `at <strong>${booking.email}</strong>` : '(if email provided)'}</li>
            <li>Email will include Customer ID and check-in link</li>
            <li>Customer can complete online check-in 24 hours before arrival</li>
          </ul>
        </div>
      `;

      approvalModal.classList.remove('hidden');
      approvalModal.classList.add('flex');
    }
    
    function closeApprovalModalFn() {
      approvalModal.classList.add('hidden');
      approvalModal.classList.remove('flex');
      currentBookingForApproval = null;
    }
    
    async function confirmApproval() {
      if (!currentBookingForApproval) return;

      try {
        confirmApprovalBtn.disabled = true;
        confirmApprovalBtn.innerHTML = '‚è≥ Processing...';

        const res = await fetch(`/api/bookings/${currentBookingForApproval.id}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            approved_by: 'admin@dolphinhouse.com'
          })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Approval failed');
        }
        const data = await res.json().catch(() => ({}));
        const sentEmail = !!data.email_sent;
        const sentSms = !!data.sms_sent;
        let note = '‚úÖ Booking approved successfully!';
        if (sentEmail && sentSms) {
          note += '\n\nSMS and Email notifications sent.';
        } else if (sentSms) {
          note += '\n\nSMS notification sent.';
        } else if (sentEmail) {
          note += '\n\nEmail notification sent.';
        } else {
          note += '\n\nNo notification sent (missing contact or provider config).';
        }
        alert(note);
        closeApprovalModalFn();
        await loadData();
        // Switch to Approved tab after successful approval
        filterTabs.forEach(t => t.classList.remove('active'));
        const approvedTab = Array.from(filterTabs).find(t => t.dataset.status === 'approved');
        if (approvedTab) {
          approvedTab.classList.add('active');
          currentStatusFilter = 'approved';
          applyFilters();
        }

      } catch (err) {
        console.error('Approval error:', err);
        alert(`Failed to approve booking: ${err.message}\n\nNote: API endpoint may not be set up yet.`);
      } finally {
        confirmApprovalBtn.disabled = false;
        confirmApprovalBtn.innerHTML = '‚úÖ Approve & Send SMS/Email';
      }
    }
    
    async function viewCheckinDetails(bookingId) {
      try {
        const res = await fetch(`/api/admin/checkin/${bookingId}`);
        if (!res.ok) {
          throw new Error('Check-in details not found');
        }
        
        const data = await res.json();
        const { booking, checkin } = data;

        checkinContent.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-600">Check-in details will be displayed here</p>
            <p class="text-sm text-gray-500 mt-2">Guest: ${booking.name}</p>
          </div>
        `;

        checkinModal.classList.remove('hidden');
        checkinModal.classList.add('flex');

      } catch (err) {
        console.error('Error loading check-in details:', err);
        alert('Check-in details not available. Guest may not have completed online check-in yet.');
      }
    }
    
    // ====================
    // EXISTING CRUD OPERATIONS
    // ====================
    
    function openAddModal() {
      editMode = false;
      modalTitle.textContent = 'Add New Booking';
      bookingForm.reset();
      document.getElementById('bookingId').value = '';
      
      const today = new Date().toISOString().split('T')[0];
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      
      document.getElementById('checkinDate').value = today;
      document.getElementById('checkoutDate').value = tomorrowStr;
      
      bookingModal.classList.remove('hidden');
    }
    
    async function openEditModal(id) {
      try {
        editMode = true;
        modalTitle.textContent = 'Edit Booking';
        
        const booking = bookings.find(b => b.id === id);
        if (!booking) {
          throw new Error('Booking not found');
        }
        
        document.getElementById('bookingId').value = booking.id;
        document.getElementById('guestName').value = booking.name || '';
        document.getElementById('guestEmail').value = booking.email || '';
        document.getElementById('guestMobile').value = booking.mobile || '';
        document.getElementById('customerId').value = booking.customer_id || '';
        // Set default to AC variant for edit (AC/Non-AC not stored)
        const roomTypeSelect = document.getElementById('roomType');
        const acVal = `${booking.room}|ac`;
        const nonAcVal = `${booking.room}|nonac`;
        if ([...roomTypeSelect.options].some(o => o.value === acVal)) {
          roomTypeSelect.value = acVal;
        } else if ([...roomTypeSelect.options].some(o => o.value === nonAcVal)) {
          roomTypeSelect.value = nonAcVal;
        }
        document.getElementById('guestCount').value = booking.guests;
        document.getElementById('checkinDate').value = booking.checkin.split('T')[0];
        document.getElementById('checkoutDate').value = booking.checkout.split('T')[0];
        document.getElementById('totalAmount').value = booking.total;
        document.getElementById('bookingStatus').value = booking.status;
        if (booking.booking_from) {
          document.getElementById('bookingFrom').value = booking.booking_from;
        }
        
        bookingModal.classList.remove('hidden');
      } catch (error) {
        console.error('Error opening edit modal:', error);
        alert('Failed to load booking details.');
      }
    }
    
    function closeBookingModal() {
      bookingModal.classList.add('hidden');
    }
    
    async function saveBooking(event) {
      event.preventDefault();
      
      try {
        const bookingId = document.getElementById('bookingId').value;
        const name = document.getElementById('guestName').value;
        const email = document.getElementById('guestEmail').value;
        const mobile = document.getElementById('guestMobile').value;
        const customer_id = document.getElementById('customerId').value;
        const roomSelection = document.getElementById('roomType').value;
        const [room] = (roomSelection || '').split('|');
        const guests = parseInt(document.getElementById('guestCount').value);
        const checkin = document.getElementById('checkinDate').value;
        const checkout = document.getElementById('checkoutDate').value;
        const total = parseFloat(document.getElementById('totalAmount').value);
        const status = document.getElementById('bookingStatus').value;
        const booking_from = document.getElementById('bookingFrom').value;
        
        const nights = calculateNights(checkin, checkout);
        
        const bookingData = {
          name,
          email,
          mobile,
          customer_id,
          room,
          guests,
          checkin,
          checkout,
          nights,
          total,
          status,
          booking_from
        };
        
        let response;
        
        if (editMode) {
          bookingData.id = bookingId;
          response = await fetch('/api/booking-crud', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookingData)
          });
        } else {
          response = await fetch('/api/booking-crud', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookingData)
          });
        }
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to save booking');
        }
        
        closeBookingModal();
        loadData();
        
        alert(editMode ? 'Booking updated successfully!' : 'New booking created successfully!');
      } catch (error) {
        console.error('Error saving booking:', error);
        alert(`Failed to save booking: ${error.message}`);
      }
    }
    
    async function deleteBooking(id) {
      if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/booking-crud?id=${id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to delete booking');
        }
        
        loadData();
        alert('Booking deleted successfully!');
      } catch (error) {
        console.error('Error deleting booking:', error);
        alert(`Failed to delete booking: ${error.message}`);
      }
    }
    
    // ====================
    // EVENT LISTENERS
    // ====================
    
    // Modal events
    addBookingBtn.addEventListener('click', openAddModal);
    closeModalBtn.addEventListener('click', closeBookingModal);
    cancelBtn.addEventListener('click', closeBookingModal);
    bookingForm.addEventListener('submit', saveBooking);
    
    // Approval modal events
    closeApprovalModal.addEventListener('click', closeApprovalModalFn);
    cancelApprovalBtn.addEventListener('click', closeApprovalModalFn);
    confirmApprovalBtn.addEventListener('click', confirmApproval);
    
    // Check-in modal events
    closeCheckinModal.addEventListener('click', () => {
      checkinModal.classList.add('hidden');
      checkinModal.classList.remove('flex');
    });
    
    // Filter events
    refreshBtn.addEventListener('click', loadData);
    dateInput.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    roomFilter.addEventListener('change', applyFilters);
    
    // Filter tab events
    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        filterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentStatusFilter = tab.dataset.status;
        applyFilters();
      });
    });
    
    // Auto-calculate nights and total when dates change
    const checkinInput = document.getElementById('checkinDate');
    const checkoutInput = document.getElementById('checkoutDate');
    
    function updateNightsAndTotal() {
      const checkin = checkinInput.value;
      const checkout = checkoutInput.value;
      
      if (checkin && checkout) {
        const nights = calculateNights(checkin, checkout);
        const roomSelection = document.getElementById('roomType').value;
        const [roomKey, acType] = (roomSelection || '').split('|');
        if (roomKey && inventory[roomKey]) {
          const inv = inventory[roomKey];
          const baseRate = acType === 'nonac'
            ? (typeof inv.rateNonAC === 'number' ? inv.rateNonAC : (inv.rateAC || 2000))
            : (typeof inv.rateAC === 'number' ? inv.rateAC : (inv.rateNonAC || 2000));
          const total = baseRate * nights;
          document.getElementById('totalAmount').value = total;
        }
      }
    }
    
    checkinInput.addEventListener('change', updateNightsAndTotal);
    checkoutInput.addEventListener('change', updateNightsAndTotal);
    // Recalculate total when Room Type (AC/Non-AC) changes
    document.getElementById('roomType').addEventListener('change', updateNightsAndTotal);

    // Initial load
    loadData();
  </script>

  <style>
    .filter-tab {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      background: white;
      transition: all 0.2s;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
    }
    
    .filter-tab:hover {
      background: #f3f4f6;
    }
    
    .filter-tab.active {
      background: #0284c7;
      color: white;
      border-color: #0284c7;
    }
    
    .filter-tab.active:hover {
      background: #0369a1;
    }
  </style>
</AdminLayout>